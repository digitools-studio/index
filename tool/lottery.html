<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æŠ½çè½‰ç›¤ï½œLottery Wheel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg: #0b0f1a; --panel: rgba(255,255,255,.06); --panel2: rgba(255,255,255,.1); --border: rgba(255,255,255,.12); }
    html,body{ height:100%; }
    body{ background: radial-gradient(1200px 600px at 10% 10%, #11203a 0%, transparent 60%),
                    radial-gradient(1200px 600px at 90% 90%, #1b163a 0%, transparent 60%),
                    var(--bg);
          color: #e5e7eb; font-family: Inter, 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; }
    .glass{ background: var(--panel); backdrop-filter: blur(10px); border:1px solid var(--border); }
    .glass-2{ background: var(--panel2); backdrop-filter: blur(10px); border:1px solid var(--border); }
    .btn{ transition: all .2s ease; cursor: pointer; }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .btn:disabled{ opacity: 0.5; cursor: not-allowed; transform: none; }
    .mono{ font-variant-numeric: tabular-nums; }

    /* Pointer arrow for the wheel */
    .pointer{ 
      width:0; height:0; 
      border-left:14px solid transparent; 
      border-right:14px solid transparent; 
      border-bottom:24px solid #f59e0b; 
      filter: drop-shadow(0 2px 8px rgba(245,158,11,0.6));
    }

    .winner-announce {
      animation: winnerPop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes winnerPop {
      0% { transform: scale(0) rotate(-180deg); opacity: 0; }
      50% { transform: scale(1.15) rotate(5deg); }
      100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }

    /* ä¸­çå…¨å±æ…¶ç¥å‹•ç•« */
    .celebration-overlay {
      position: fixed;
      inset: 0;
      z-index: 9999;
      pointer-events: none;
      animation: celebrationFade 3s ease-out forwards;
    }
    @keyframes celebrationFade {
      0% { opacity: 1; }
      70% { opacity: 1; }
      100% { opacity: 0; }
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: #f59e0b;
      animation: confettiFall 3s ease-out forwards;
    }
    @keyframes confettiFall {
      0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }

    /* è½‰ç›¤é–ƒå…‰æ•ˆæœ */
    .wheel-glow {
      animation: wheelGlow 0.5s ease-in-out;
    }
    @keyframes wheelGlow {
      0%, 100% { filter: drop-shadow(0 0 0 transparent); }
      50% { filter: drop-shadow(0 0 30px rgba(245,158,11,0.8)); }
    }

    /* å¾—çè€…å½ˆå‡ºå‹•ç•« */
    .winner-modal {
      animation: modalSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    @keyframes modalSlideIn {
      0% { transform: translateY(-100px) scale(0.5); opacity: 0; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }

    .scrollbar-thin::-webkit-scrollbar{ height:6px; width:6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb{ background:#374151; border-radius:6px; }
    
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse-border {
      animation: pulseBorder 2s ease-in-out infinite;
    }
    @keyframes pulseBorder {
      0%, 100% { border-color: rgba(245,158,11,0.3); }
      50% { border-color: rgba(245,158,11,0.8); }
    }

    /* æŒ‰éˆ•é»æ“Šæ¼£æ¼ªæ•ˆæœ */
    .ripple {
      position: relative;
      overflow: hidden;
    }
    .ripple::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255,255,255,0.5);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    .ripple:active::after {
      width: 300px;
      height: 300px;
    }

    /* Logoé–ƒå…‰å‹•ç•« */
    @keyframes shimmer {
      0% { transform: translateX(-100%) rotate(45deg); }
      100% { transform: translateX(200%) rotate(45deg); }
    }
    .animate-shimmer {
      animation: shimmer 3s infinite;
    }
  </style>
</head>
<body>
<div id="app" class="max-w-7xl mx-auto px-4 py-6 md:py-10">
  <!-- Header -->
  <header class="flex flex-col md:flex-row md:items-center gap-4 md:gap-6 mb-6">
    <div class="flex-1 flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-amber-400 to-pink-500 flex items-center justify-center relative overflow-hidden">
        <div class="absolute inset-0 bg-white/20 rotate-45 transform translate-x-full animate-shimmer"></div>
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <circle cx="12" cy="12" r="10" stroke-width="2"/>
          <path d="M12 6v12M6 12h12" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
      <div>
        <h1 class="text-xl md:text-2xl font-bold tracking-tight">{{ t('title') }}</h1>
        <p class="text-sm text-gray-400">{{ t('subtitle') }}</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <select v-model="currentLanguage" class="glass px-3 py-2 rounded-lg text-sm">
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
      </select>
      <button class="btn glass px-3 py-2 rounded-lg text-sm hover:bg-white/10" @click="loadSample">{{ t('btn_sample') }}</button>
    </div>
  </header>

  <!-- åŸºæœ¬è³‡è¨Šå€ -->
  <div class="glass rounded-2xl p-5 md:p-6 mb-6">
    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
      <div class="h-6 w-1 bg-gradient-to-b from-amber-400 to-pink-500 rounded-full"></div>
      æŠ½çåŸºæœ¬è³‡è¨Š
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm text-gray-300 mb-2">æŠ½çä¸»é¡Œ *</label>
        <input v-model="lotteryPurpose" class="glass-2 w-full rounded-lg p-3 text-sm" placeholder="ä¾‹å¦‚ï¼šå¹´çµ‚å°¾ç‰™æŠ½çã€éƒ¨é–€èšé¤æŠ½ç" />
      </div>
      <div>
        <label class="block text-sm text-gray-300 mb-2">çé …èªªæ˜ï¼ˆé¸å¡«ï¼‰</label>
        <input v-model="lotteryOptions" class="glass-2 w-full rounded-lg p-3 text-sm" placeholder="ä¾‹å¦‚ï¼šé ­ç iPhoneã€è²³ç AirPods" />
      </div>
    </div>
  </div>

  <!-- é€²éšè¨­å®šå€ -->
  <div class="glass rounded-2xl p-5 md:p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold flex items-center gap-2">
        <div class="h-6 w-1 bg-gradient-to-b from-purple-400 to-indigo-500 rounded-full"></div>
        é€²éšè¨­å®š
      </h3>
      <button @click="showAdvancedSettings = !showAdvancedSettings" class="text-sm text-gray-400 hover:text-white">
        {{ showAdvancedSettings ? 'æ”¶èµ· â–²' : 'å±•é–‹ â–¼' }}
      </button>
    </div>
    
    <div v-show="showAdvancedSettings" class="space-y-4">
      <!-- Row 1: Draw Mode & Animation Speed -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm text-gray-200 font-medium mb-2">æŠ½çæ¨¡å¼</label>
          <select v-model="drawMode" class="w-full rounded-lg p-3 text-sm bg-gray-800 border border-gray-600 text-white focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 outline-none transition-all">
            <option value="single">å–®æ¬¡æŠ½ç</option>
            <option value="batch">æ‰¹æ¬¡æŠ½ç</option>
            <option value="group">åˆ†çµ„æŠ½ç</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-gray-200 font-medium mb-2">å‹•ç•«é€Ÿåº¦</label>
          <select v-model="animationSpeed" class="w-full rounded-lg p-3 text-sm bg-gray-800 border border-gray-600 text-white focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 outline-none transition-all">
            <option value="fast">å¿«é€Ÿ (2ç§’)</option>
            <option value="normal">æ­£å¸¸ (4ç§’)</option>
            <option value="slow">æ…¢é€Ÿ (6ç§’)</option>
          </select>
        </div>
        <div class="flex items-end">
          <label class="flex items-center gap-3 cursor-pointer p-3 bg-gray-800 border border-gray-600 rounded-lg w-full hover:bg-gray-700 transition-colors">
            <input type="checkbox" v-model="enableSound" class="w-5 h-5 rounded border-gray-500 text-amber-500 focus:ring-2 focus:ring-amber-400/20">
            <span class="text-sm text-gray-100 font-medium">å•Ÿç”¨éŸ³æ•ˆ</span>
          </label>
        </div>
      </div>
      
      <!-- Row 2: Blacklist & Show History -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="flex items-center gap-3 cursor-pointer p-3 bg-gray-800 border border-gray-600 rounded-lg hover:bg-gray-700 transition-colors">
          <input type="checkbox" v-model="enableBlacklist" class="w-5 h-5 rounded border-gray-500 text-amber-500 focus:ring-2 focus:ring-amber-400/20">
          <span class="text-sm text-gray-100 font-medium">å•Ÿç”¨é»‘åå–®åŠŸèƒ½</span>
        </label>
        <label class="flex items-center gap-3 cursor-pointer p-3 bg-gray-800 border border-gray-600 rounded-lg hover:bg-gray-700 transition-colors">
          <input type="checkbox" v-model="showHistory" class="w-5 h-5 rounded border-gray-500 text-amber-500 focus:ring-2 focus:ring-amber-400/20">
          <span class="text-sm text-gray-100 font-medium">é¡¯ç¤ºæŠ½çç´€éŒ„</span>
        </label>
      </div>
      
      <!-- Prize Settings -->
      <div v-if="drawMode === 'batch'" class="border-t border-white/10 pt-4">
        <div class="flex items-center justify-between mb-3">
          <label class="text-sm text-gray-200 font-semibold">çé …è¨­å®š</label>
          <button @click="addPrizeSetting" class="text-xs bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 px-3 py-1.5 rounded-lg text-white font-medium shadow-lg">
            â• æ–°å¢çé …
          </button>
        </div>
        <div v-if="prizeSettings.length === 0" class="text-sm text-gray-400 text-center py-4 bg-gray-800/50 rounded-lg">
          å°šæœªè¨­å®šçé …ï¼Œé»æ“Šã€Œæ–°å¢çé …ã€é–‹å§‹è¨­å®š
        </div>
        <div v-else class="space-y-2">
          <div v-for="(prize, index) in prizeSettings" :key="index" 
               class="bg-gray-800 border border-gray-600 p-3 rounded-lg flex items-center gap-3"
               :class="index === currentPrizeIndex ? 'ring-2 ring-amber-400 border-amber-400' : ''">
            <div class="flex-1 grid grid-cols-2 gap-2">
              <input v-model="prize.name" class="bg-gray-900 border border-gray-600 text-white px-3 py-2 rounded text-sm focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 outline-none" placeholder="çé …åç¨±" />
              <input v-model.number="prize.count" type="number" min="1" class="bg-gray-900 border border-gray-600 text-white px-3 py-2 rounded text-sm focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 outline-none" placeholder="äººæ•¸" />
            </div>
            <span class="text-xs text-amber-400 font-medium">{{ prize.drawn }}/{{ prize.count }}</span>
            <button @click="removePrizeSetting(index)" class="text-red-400 hover:text-red-300 text-sm font-bold">âœ•</button>
          </div>
        </div>
      </div>
      
      <!-- Blacklist Management -->
      <div v-if="enableBlacklist" class="border-t border-white/10 pt-4">
        <label class="block text-sm text-gray-200 mb-2 font-semibold">é»‘åå–®ç®¡ç†</label>
        <div class="flex gap-2 mb-2">
          <input v-model="blacklistInput" @keyup.enter="addToBlacklist" class="flex-1 px-3 py-2 rounded text-sm bg-gray-800 border border-gray-600 text-white focus:border-amber-400 focus:ring-2 focus:ring-amber-400/20 outline-none" placeholder="è¼¸å…¥è¦åŠ å…¥é»‘åå–®çš„åå­—" />
          <button @click="addToBlacklist" class="bg-gradient-to-r from-red-500 to-pink-600 hover:from-red-400 hover:to-pink-500 px-4 py-2 rounded-lg text-sm text-white font-medium shadow-lg">
            åŠ å…¥
          </button>
        </div>
        <div v-if="blacklist.length === 0" class="text-sm text-gray-400 text-center py-2 bg-gray-800/50 rounded-lg">
          å°šç„¡é»‘åå–®
        </div>
        <div v-else class="flex flex-wrap gap-2">
          <span v-for="(name, index) in blacklist" :key="index" 
                class="bg-gray-800 border border-red-500/30 px-3 py-1.5 rounded-full text-sm flex items-center gap-2 text-gray-100">
            {{ name }}
            <button @click="removeFromBlacklist(index)" class="text-red-400 hover:text-red-300 font-bold">âœ•</button>
          </span>
        </div>
      </div>
      
      <!-- Settings Save/Load -->
      <div class="border-t border-white/10 pt-4 flex gap-3">
        <button @click="saveSettings" class="btn bg-gray-800 border border-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm text-gray-100 font-medium ripple shadow-lg">
          ğŸ’¾ å„²å­˜è¨­å®š
        </button>
        <button @click="loadSettings" class="btn bg-gray-800 border border-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-sm text-gray-100 font-medium ripple shadow-lg">
          ğŸ“‚ è¼‰å…¥è¨­å®š
        </button>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Left: Controls -->
    <section class="glass rounded-2xl p-5 md:p-6">

      <!-- Roster -->
      <div>
        <div class="flex items-center justify-between mb-3">
          <label class="block text-sm font-semibold text-gray-200 flex items-center gap-2">
            <div class="h-5 w-1 bg-gradient-to-b from-blue-400 to-purple-500 rounded-full"></div>
            åƒèˆ‡è€…åå–®
          </label>
          <span class="text-xs glass-2 px-2 py-1 rounded-full">ç¸½è¨ˆ {{ rosterTable.length }} äºº</span>
        </div>
        <div class="space-y-2 max-h-64 overflow-y-auto scrollbar-thin">
          <div v-for="(p, idx) in rosterTable" :key="p.uid" class="flex gap-2 items-center fade-in">
            <span class="text-xs text-gray-400 w-6">{{ idx + 1 }}</span>
            <input
              v-model="p.name"
              @input="validateName(idx)"
              :class="['glass-2 flex-1 rounded-lg p-2.5 text-sm', p.nameError ? 'border-2 border-red-400' : '']"
              placeholder="è¼¸å…¥å§“å"
            />
            <div class="flex items-center gap-1">
              <label class="text-xs text-gray-400">æ¬Šé‡</label>
              <input
                v-model.number="p.weight"
                @input="validateWeight(idx)"
                type="number"
                min="1"
                :class="['glass-2 w-16 rounded-lg p-2.5 text-sm text-center', p.weightError ? 'border-2 border-red-400' : '']"
                placeholder="1"
              />
            </div>
            <button class="btn px-2 py-1.5 rounded-lg bg-red-500/80 hover:bg-red-500 text-white text-xs" @click="removeRow(idx)" v-if="rosterTable.length>1">âœ•</button>
          </div>
        </div>
        <div v-if="rosterError" class="mt-2 p-2 rounded-lg bg-red-500/20 border border-red-500/40 text-red-400 text-xs">âš ï¸ {{ rosterError }}</div>
        <div class="flex gap-2 mt-3 flex-wrap">
          <button class="btn glass-2 px-3 py-2 rounded-lg text-sm ripple" @click="addRow">+ æ–°å¢</button>
          <button class="btn glass-2 px-3 py-2 rounded-lg text-sm ripple" @click="batchPaste">æ‰¹æ¬¡è²¼ä¸Š</button>
          <button class="btn glass-2 px-3 py-2 rounded-lg text-sm ripple" @click="clearRoster">æ¸…ç©º</button>
          <button class="btn bg-gradient-to-r from-amber-500 to-amber-600 hover:from-amber-400 hover:to-amber-500 text-white font-semibold px-4 py-2 rounded-lg text-sm ripple shadow-lg" @click="parseParticipants" :disabled="!!rosterError || rosterTable.length === 0">ç¢ºèªåå–®</button>
        </div>
      </div>

      <hr class="border-white/10 my-5" />

      <!-- Options -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-200 mb-3 flex items-center gap-2">
            <div class="h-5 w-1 bg-gradient-to-b from-green-400 to-emerald-500 rounded-full"></div>
            æŠ½çè¨­å®š
          </label>
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-xs text-gray-400 mb-2">{{ t('draw_count') }}</label>
              <input type="number" min="1" v-model.number="drawCount" class="glass-2 w-full rounded-lg p-3 text-sm font-semibold text-center" />
            </div>
            <div class="flex items-end">
              <label class="flex items-center gap-2 glass-2 w-full p-3 rounded-lg cursor-pointer hover:bg-white/5 transition-all">
                <input type="checkbox" v-model="noRepeat" class="rounded w-4 h-4" />
                <span class="text-sm text-gray-300">{{ t('no_repeat') }}</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-6">
        <div class="bg-gradient-to-r from-amber-500/10 to-pink-500/10 border border-amber-500/30 rounded-xl p-4 mb-4">
          <div class="flex items-center justify-between text-sm">
            <div class="flex items-center gap-4">
              <div>
                <span class="text-gray-400">{{ t('stats_total') }}</span>
                <span class="font-bold text-lg ml-1 mono text-amber-400">{{ participants.length }}</span>
              </div>
              <div>
                <span class="text-gray-400">{{ t('stats_eligible') }}</span>
                <span class="font-bold text-lg ml-1 mono text-green-400">{{ eligibleCount }}</span>
              </div>
              <div>
                <span class="text-gray-400">å·²ä¸­çï¼š</span>
                <span class="font-bold text-lg ml-1 mono text-pink-400">{{ participants.length - eligibleCount }}</span>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Session Progress Bar -->
        <div v-if="isSessionActive" class="mb-4 p-4 glass-2 rounded-xl">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm text-gray-300">æœ¬è¼ªæŠ½çé€²åº¦</span>
            <span class="text-sm font-bold text-amber-400 mono">{{ currentSessionDrawn }} / {{ maxDrawPerSession }}</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
            <div class="h-full bg-gradient-to-r from-amber-400 via-amber-500 to-pink-500 rounded-full transition-all duration-500 ease-out"
                 :style="{width: sessionProgress + '%'}"></div>
          </div>
          <div v-if="currentPrize" class="mt-2 text-sm text-amber-300">
            ç•¶å‰çé …ï¼š{{ currentPrize.name }} ({{ currentPrize.drawn }}/{{ currentPrize.count }})
          </div>
        </div>
        
        <div class="flex flex-wrap gap-3">
          <!-- Session Control Buttons -->
          <button v-if="!isSessionActive" 
                  class="btn bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-400 hover:to-emerald-500 text-white font-bold px-6 py-4 rounded-xl ripple shadow-xl"
                  @click="startNewSession">
            ğŸš€ é–‹å§‹æ–°ä¸€è¼ª
          </button>
          <button v-else-if="currentSessionDrawn >= maxDrawPerSession"
                  class="btn bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-400 hover:to-indigo-500 text-white font-bold px-6 py-4 rounded-xl ripple shadow-xl"
                  @click="resetAndRestart">
            ğŸ”„ é‡æ–°é–‹å§‹
          </button>
          <button v-else-if="isSessionActive"
                  class="btn glass-2 px-4 py-4 rounded-xl ripple hover:bg-red-500/20 text-red-400"
                  @click="endSession">
            â¹ï¸ çµæŸæœ¬è¼ª
          </button>
          
          <!-- Draw Button -->
          <button class="btn bg-gradient-to-r from-amber-500 via-amber-600 to-pink-500 hover:from-amber-400 hover:via-amber-500 hover:to-pink-400 text-white font-bold px-8 py-4 rounded-xl disabled:opacity-60 disabled:cursor-not-allowed flex items-center gap-3 shadow-xl ripple relative overflow-hidden group" 
                  :disabled="!canDraw" 
                  @click="drawWinners"
                  :class="isDrawing ? 'pulse-border' : ''">
            <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
            <span v-if="!isDrawing" class="text-xl relative z-10">â­</span>
            <span v-else class="animate-spin text-xl relative z-10">â³</span>
            <span class="relative z-10 text-lg">{{ isDrawing ? t('btn_drawing') : t('btn_draw') }}</span>
          </button>
          
          <button class="btn glass-2 px-4 py-4 rounded-xl ripple hover:bg-white/10" @click="resetEligibility">é‡ç½®è³‡æ ¼</button>
          <button class="btn glass-2 px-4 py-4 rounded-xl ripple hover:bg-white/10" :disabled="drawLog.length===0" @click="exportLog">åŒ¯å‡ºJSON</button>
          <button class="btn glass-2 px-4 py-4 rounded-xl ripple hover:bg-white/10" :disabled="drawLog.length===0" @click="exportXLSX">åŒ¯å‡ºXLSX</button>
        </div>
      </div>
    </section>

    <!-- Right: Visual + Results -->
    <section class="glass rounded-2xl p-5 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold flex items-center gap-2">
          <div class="h-6 w-1 bg-gradient-to-b from-amber-400 to-pink-500 rounded-full"></div>
          {{ t('visual_title') }}
        </h3>
        <div class="flex items-center gap-2 text-xs">
          <div class="flex items-center gap-1.5 glass-2 px-2 py-1 rounded-full">
            <span class="inline-block h-3 w-3 rounded-full bg-amber-500 animate-pulse"></span>
            <span class="text-gray-300">{{ t('legend_pointer') }}</span>
          </div>
        </div>
      </div>
      <div class="rounded-2xl glass-2 p-6 min-h-[360px] md:min-h-[420px] flex items-center justify-center relative overflow-hidden border border-white/5" ref="wheelContainer">
        <!-- fixed pointer for wheel mode -->
        <div class="absolute top-4 left-1/2 -translate-x-1/2 z-10">
          <div class="pointer"></div>
        </div>
        <!-- Wheel Component -->
        <wheel-canvas ref="visualRef" :items="participants" class="w-full"></wheel-canvas>
        
        <!-- ç•¶æ²’æœ‰åƒèˆ‡è€…æ™‚çš„æç¤º -->
        <div v-if="participants.length === 0" class="absolute inset-0 flex items-center justify-center">
          <div class="text-center">
            <div class="w-24 h-24 mx-auto mb-4 rounded-full bg-gradient-to-br from-gray-600 to-gray-800 flex items-center justify-center">
              <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <path d="M12 6v12M6 12h12" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </div>
            <p class="text-gray-400 text-lg">è«‹å…ˆç¢ºèªåƒèˆ‡è€…åå–®</p>
          </div>
        </div>
      </div>

      <!-- Winners Display -->
      <div class="mt-6">
        <div class="flex items-center justify-between gap-2 mb-3">
          <h4 class="font-semibold flex items-center gap-2">
            <div class="h-5 w-1 bg-gradient-to-b from-yellow-400 to-amber-500 rounded-full"></div>
            <span>{{ t('winners_latest') }}</span>
            <span v-if="isSessionActive" class="text-xs px-2 py-0.5 rounded-full bg-amber-500/20 text-amber-400 border border-amber-500/30 font-medium animate-pulse">æœ¬è¼ª</span>
          </h4>
          <button class="btn text-xs px-3 py-1.5 rounded-md glass-2 hover:bg-red-500/20 ripple" @click="winners=[]">æ¸…ç©º</button>
        </div>
        <div class="flex flex-wrap gap-2 max-h-32 overflow-auto scrollbar-thin glass-2 p-3 rounded-xl">
          <span v-for="(w,i) in winners" :key="'w-'+i" 
                class="px-4 py-2 rounded-lg bg-gradient-to-r from-amber-500 to-pink-500 text-white text-sm font-medium winner-announce shadow-lg flex items-center gap-2">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            <span v-if="w.prize" class="text-xs opacity-75">[{{ w.prize }}]</span>
            {{ w.name }} <span class="opacity-75 text-xs ml-1">({{ t('label_round') }} {{ w.round }})</span>
          </span>
          <span v-if="winners.length===0 && !isSessionActive" class="text-sm text-gray-400 p-2">
            {{ t('no_winners_yet') }}
            <span class="text-xs text-amber-400 ml-2">â†’ é»æ“Šã€ŒğŸš€ é–‹å§‹æ–°ä¸€è¼ªã€é–‹å§‹æŠ½ç</span>
          </span>
          <span v-if="winners.length===0 && isSessionActive" class="text-sm text-gray-400 p-2">å°šæœªæŠ½å‡ºï¼Œé»æ“Šã€Œâ­ é–‹å§‹æŠ½çã€æŒ‰éˆ•é–‹å§‹</span>
        </div>
      </div>

      <!-- å·²ä¸­çåå–®ç®¡ç† -->
      <div class="mt-6" v-if="participants.length > 0">
        <div class="flex items-center justify-between gap-2 mb-3">
          <h4 class="font-semibold flex items-center gap-2">
            <div class="h-5 w-1 bg-gradient-to-b from-blue-400 to-purple-500 rounded-full"></div>
            åƒèˆ‡è€…ç‹€æ…‹
          </h4>
          <div class="text-xs glass-2 px-3 py-1 rounded-full">
            <span class="text-green-400">â— {{ eligibleCount }} å¯æŠ½</span>
            <span class="text-gray-400 mx-1">/</span>
            <span class="text-pink-400">â— {{ participants.length - eligibleCount }} å·²ä¸­</span>
          </div>
        </div>
        <div class="glass-2 rounded-xl p-3 max-h-48 overflow-auto scrollbar-thin">
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
            <div v-for="p in participants" :key="p.id" 
                 class="flex items-center gap-2 p-2 rounded-lg text-sm transition-all"
                 :class="p.eligible ? 'bg-green-500/10 border border-green-500/30 hover:bg-green-500/20' : 'bg-pink-500/10 border border-pink-500/30 opacity-60'">
              <div class="w-2 h-2 rounded-full" :class="p.eligible ? 'bg-green-400' : 'bg-pink-400'"></div>
              <span class="flex-1 truncate">{{ p.name }}</span>
              <span class="text-xs text-gray-400">({{ p.weight }})</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Log -->
      <div class="mt-6">
        <div class="flex items-center justify-between mb-3">
          <h4 class="font-semibold flex items-center gap-2">
            <div class="h-5 w-1 bg-gradient-to-b from-indigo-400 to-purple-500 rounded-full"></div>
            {{ t('log_title') }}
          </h4>
          <span class="text-xs glass-2 px-2 py-1 rounded-full">ç¸½è¨ˆ {{ drawLog.length }} ç­†</span>
        </div>
        <div class="overflow-auto max-h-64 rounded-xl glass-2 border border-white/5">
          <table class="w-full text-sm">
            <thead class="text-gray-300 bg-black/20 sticky top-0">
            <tr>
              <th class="text-left px-3 py-3 font-semibold">{{ t('th_time') }}</th>
              <th class="text-left px-3 py-3 font-semibold">{{ t('th_round') }}</th>
              <th v-if="prizeSettings.length > 0" class="text-left px-3 py-3 font-semibold">çé …</th>
              <th v-if="isSessionActive" class="text-left px-3 py-3 font-semibold">é€²åº¦</th>
              <th class="text-left px-3 py-3 font-semibold">{{ t('th_winners') }}</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="(row, idx) in drawLog" :key="'log-'+idx" class="border-t border-white/10 hover:bg-white/5 transition-colors">
              <td class="px-3 py-3 whitespace-nowrap text-xs text-gray-400">{{ row.time }}</td>
              <td class="px-3 py-3">
                <span class="inline-block px-2 py-0.5 rounded-full bg-gradient-to-r from-amber-500/20 to-pink-500/20 text-amber-400 text-xs font-semibold">{{ row.round }}</span>
              </td>
              <td v-if="prizeSettings.length > 0" class="px-3 py-3">
                <span v-if="row.prize" class="inline-block px-2 py-0.5 rounded-full bg-gradient-to-r from-purple-500/20 to-indigo-500/20 text-purple-400 text-xs font-semibold">{{ row.prize }}</span>
                <span v-else class="text-gray-500 text-xs">-</span>
              </td>
              <td v-if="isSessionActive" class="px-3 py-3 whitespace-nowrap text-xs text-gray-400">
                {{ row.sessionProgress || '-' }}
              </td>
              <td class="px-3 py-3">
                <span class="font-medium text-white">{{ row.winners.join(', ') }}</span>
              </td>
            </tr>
            <tr v-if="drawLog.length===0">
              <td class="px-3 py-6 text-center text-gray-500" :colspan="3 + (prizeSettings.length > 0 ? 1 : 0) + (isSessionActive ? 1 : 0)">
                <div class="w-16 h-16 mx-auto mb-3 rounded-full bg-gray-800/50 flex items-center justify-center">
                  <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                </div>
                {{ t('log_empty') }}
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
const { createApp, defineComponent } = Vue;

/* ===================== i18n ===================== */
const i18nData = {
  'zh-TW': {
    title: 'æŠ½çè½‰ç›¤',
    subtitle: 'ç°¡å–®æ˜“ç”¨çš„ç·šä¸ŠæŠ½çå·¥å…· Â· å…¬å¹³å…¬æ­£ Â· å¤šèªç³»æ”¯æ´',
    btn_sample: 'è¼‰å…¥ç¯„ä¾‹',
    roster_label: 'åƒèˆ‡è€…åå–®',
    btn_parse: 'è§£æåå–®', btn_clear: 'æ¸…ç©ºåå–®',
    draw_count: 'æœ¬æ¬¡æŠ½å‡ºäººæ•¸', no_repeat: 'æŠ½å‡ºå¾Œæ’é™¤ï¼ˆé¿å…é‡è¤‡ï¼‰',
    rng_title: 'éš¨æ©Ÿæ¨¡å¼', 
    rng_crypto: 'Crypto åŠ å¯†éš¨æ©Ÿ', 
    rng_seeded: 'Seeded å¯é©—è­‰éš¨æ©Ÿ', 
    rng_math: 'Math.random åŸºæœ¬éš¨æ©Ÿ',
    seed_salt: 'Saltï¼ˆé¹½å€¼ï¼‰', 
    btn_gen_salt: 'ç”¢ç”Ÿ', 
    seed_public: 'Public Seedï¼ˆå…¬é–‹ç¨®å­ï¼‰', 
    seed_public_ph: 'ä¾‹å¦‚ï¼š2025-01-03-Event-A', 
    seed_tip: 'é©—è­‰æ–¹å¼ï¼šç›¸åŒåå–®ã€æ¬Šé‡ã€Saltã€Public Seedã€æŠ½å–åºåˆ— â†’ çµæœå¯é‡ç¾',
    btn_draw: 'é–‹å§‹æŠ½ç', 
    btn_drawing: 'æŠ½çä¸­...', 
    btn_reset_eligibility: 'æ¢å¾©æ‰€æœ‰è³‡æ ¼', 
    btn_export: 'åŒ¯å‡º JSON',
    stats_total: 'ç¸½äººæ•¸ï¼š', 
    stats_eligible: 'å¯æŠ½ï¼š',
    visual_title: 'æŠ½çè½‰ç›¤', 
    legend_pointer: 'æŒ‡é‡',
    winners_latest: 'æœ¬æ¬¡å¾—çè€…', 
    btn_clear_winners: 'æ¸…ç©º', 
    label_round: 'è¼ª', 
    no_winners_yet: 'å°šç„¡å¾—çè€…',
    log_title: 'æŠ½çç´€éŒ„', 
    th_time: 'æ™‚é–“', 
    th_round: 'è¼ªæ¬¡', 
    th_method: 'éš¨æ©Ÿæ¨¡å¼', 
    th_winners: 'å¾—çè€…', 
    log_empty: 'å°šç„¡æŠ½çç´€éŒ„'
  },
  'zh-CN': {
    title: 'æŠ½å¥–è½¬ç›˜',
    subtitle: 'ç®€å•æ˜“ç”¨çš„åœ¨çº¿æŠ½å¥–å·¥å…· Â· å…¬å¹³å…¬æ­£ Â· å¤šè¯­è¨€æ”¯æŒ',
    btn_sample: 'è½½å…¥ç¤ºä¾‹',
    roster_label: 'å‚ä¸è€…åå•',
    btn_parse: 'è§£æåå•', btn_clear: 'æ¸…ç©ºåå•',
    draw_count: 'æœ¬æ¬¡æŠ½å–äººæ•°', no_repeat: 'æŠ½ä¸­åæ’é™¤ï¼ˆé¿å…é‡å¤ï¼‰',
    rng_title: 'éšæœºæ¨¡å¼', 
    rng_crypto: 'Crypto åŠ å¯†éšæœº', 
    rng_seeded: 'Seeded å¯éªŒè¯éšæœº', 
    rng_math: 'Math.random åŸºæœ¬éšæœº',
    seed_salt: 'Saltï¼ˆç›å€¼ï¼‰', 
    btn_gen_salt: 'ç”Ÿæˆ', 
    seed_public: 'Public Seedï¼ˆå…¬å¼€ç§å­ï¼‰', 
    seed_public_ph: 'ä¾‹å¦‚ï¼š2025-01-03-Event-A', 
    seed_tip: 'éªŒè¯ï¼šç›¸åŒåå•ã€æƒé‡ã€Saltã€Seedã€åºåˆ— â†’ ç»“æœå¯å¤ç°',
    btn_draw: 'å¼€å§‹æŠ½å¥–', 
    btn_drawing: 'æŠ½å¥–ä¸­...', 
    btn_reset_eligibility: 'æ¢å¤æ‰€æœ‰èµ„æ ¼', 
    btn_export: 'å¯¼å‡º JSON',
    stats_total: 'æ€»äººæ•°ï¼š', 
    stats_eligible: 'å¯æŠ½ï¼š',
    visual_title: 'æŠ½å¥–è½¬ç›˜', 
    legend_pointer: 'æŒ‡é’ˆ',
    winners_latest: 'æœ¬æ¬¡ä¸­å¥–è€…', 
    btn_clear_winners: 'æ¸…ç©º', 
    label_round: 'è½®', 
    no_winners_yet: 'æš‚æ— ä¸­å¥–è€…',
    log_title: 'æŠ½å¥–è®°å½•', 
    th_time: 'æ—¶é—´', 
    th_round: 'è½®æ¬¡', 
    th_method: 'éšæœºæ¨¡å¼', 
    th_winners: 'ä¸­å¥–è€…', 
    log_empty: 'æš‚æ— è®°å½•'
  },
  'en': {
    title: 'Lottery Wheel',
    subtitle: 'Simple & Fair Online Lottery Tool Â· Multi-language',
    btn_sample: 'Load Sample',
    roster_label: 'Participants',
    btn_parse: 'Parse', btn_clear: 'Clear',
    draw_count: 'Winners to draw', no_repeat: 'Exclude winners',
    rng_title: 'Random Mode', 
    rng_crypto: 'Crypto Random', 
    rng_seeded: 'Seeded (Verifiable)', 
    rng_math: 'Math.random',
    seed_salt: 'Salt', 
    btn_gen_salt: 'Generate', 
    seed_public: 'Public Seed', 
    seed_public_ph: 'e.g., 2025-01-03-Event-A', 
    seed_tip: 'Verification: same roster, weights, Salt, Seed, sequence â†’ reproducible',
    btn_draw: 'Draw', 
    btn_drawing: 'Drawing...', 
    btn_reset_eligibility: 'Reset All', 
    btn_export: 'Export JSON',
    stats_total: 'Total:', 
    stats_eligible: 'Eligible:',
    visual_title: 'Lottery Wheel', 
    legend_pointer: 'Pointer',
    winners_latest: 'Latest Winners', 
    btn_clear_winners: 'Clear', 
    label_round: 'R', 
    no_winners_yet: 'No winners yet',
    log_title: 'Draw Log', 
    th_time: 'Time', 
    th_round: 'Round', 
    th_method: 'Method', 
    th_winners: 'Winners', 
    log_empty: 'No records'
  },
  'ja': {
    title: 'æŠ½é¸ãƒ›ã‚¤ãƒ¼ãƒ«',
    subtitle: 'ã‚·ãƒ³ãƒ—ãƒ«ã§å…¬å¹³ãªã‚ªãƒ³ãƒ©ã‚¤ãƒ³æŠ½é¸ãƒ„ãƒ¼ãƒ«',
    btn_sample: 'ã‚µãƒ³ãƒ—ãƒ«',
    roster_label: 'å‚åŠ è€…',
    btn_parse: 'è§£æ', btn_clear: 'ã‚¯ãƒªã‚¢',
    draw_count: 'å½“é¸äººæ•°', no_repeat: 'å½“é¸è€…ã‚’é™¤å¤–',
    rng_title: 'ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰', 
    rng_crypto: 'Crypto', 
    rng_seeded: 'Seededï¼ˆæ¤œè¨¼å¯èƒ½ï¼‰', 
    rng_math: 'Math.random',
    seed_salt: 'Salt', 
    btn_gen_salt: 'ç”Ÿæˆ', 
    seed_public: 'Public Seed', 
    seed_public_ph: 'ä¾‹ï¼š2025-01-03-Event-A', 
    seed_tip: 'æ¤œè¨¼ï¼šåŒã˜åç°¿ãƒ»é‡ã¿ãƒ»Saltãƒ»Seedãƒ»é †åº â†’ å†ç¾å¯èƒ½',
    btn_draw: 'æŠ½é¸', 
    btn_drawing: 'æŠ½é¸ä¸­...', 
    btn_reset_eligibility: 'ãƒªã‚»ãƒƒãƒˆ', 
    btn_export: 'JSONå‡ºåŠ›',
    stats_total: 'ç·æ•°ï¼š', 
    stats_eligible: 'å¯èƒ½ï¼š',
    visual_title: 'æŠ½é¸ãƒ›ã‚¤ãƒ¼ãƒ«', 
    legend_pointer: 'ãƒã‚¤ãƒ³ã‚¿',
    winners_latest: 'å½“é¸è€…', 
    btn_clear_winners: 'ã‚¯ãƒªã‚¢', 
    label_round: 'å›', 
    no_winners_yet: 'ã¾ã ã‚ã‚Šã¾ã›ã‚“',
    log_title: 'æŠ½é¸ãƒ­ã‚°', 
    th_time: 'æ™‚åˆ»', 
    th_round: 'å›', 
    th_method: 'ãƒ¢ãƒ¼ãƒ‰', 
    th_winners: 'å½“é¸è€…', 
    log_empty: 'ãƒ­ã‚°ãªã—'
  }
};

/* ===================== Components ===================== */
const WheelCanvas = defineComponent({
  name: 'WheelCanvas',
  props: { items: { type: Array, required: true } },
  template: `
    <div class="w-full flex items-center justify-center select-none">
      <canvas ref="canvas" :width="size" :height="size" class="max-w-full" style="max-height: 400px;"></canvas>
    </div>
  `,
  data(){ return { size: 400, rotation: 0, animId: null, spinning: false }; },
  watch:{ 
    items: {
      handler(newItems, oldItems){ 
        // åªæœ‰åœ¨ä¸æ˜¯æ—‹è½‰ä¸­æ™‚æ‰é‡ç¹ª
        if(!this.spinning) {
          console.log('ğŸ“Š items changed, redrawing wheel');
          this.$nextTick(() => {
            this.draw(); 
          });
        } else {
          console.log('â¸ï¸ Spinning in progress, skip redraw');
        }
      },
      deep: true,
      flush: 'post'
    }
  },
  mounted(){ 
    console.log('ğŸª WheelCanvas mounted');
    this.$nextTick(() => {
      this.draw();
    });
  },
  beforeUnmount(){ if(this.animId) cancelAnimationFrame(this.animId); },
  methods:{
    draw(){
      const cvs = this.$refs.canvas; if(!cvs) return; const ctx = cvs.getContext('2d');
      // åªé¡¯ç¤ºeligibleç‚ºtrueçš„åƒèˆ‡è€…
      const eligibleItems = this.items.filter(item => item.eligible !== false);
      const N = Math.max(1, eligibleItems.length);
      ctx.clearRect(0,0,cvs.width,cvs.height);
      const R = this.size/2 - 10; 
      const cx = this.size/2; 
      const cy = this.size/2;
      const aPer = Math.PI * 2 / N;
      
      ctx.save(); 
      ctx.translate(cx,cy); 
      ctx.rotate(this.rotation);
      
      // ç¹ªè£½è½‰ç›¤æ‰‡å½¢
      for(let i=0;i<N;i++){
        const start = i*aPer; 
        const end = start + aPer;
        ctx.beginPath();
        
        // ä½¿ç”¨æ›´è±å¯Œçš„æ¼¸è®Šè‰²
        const hue = (i*360/N)|0; 
        const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, R);
        gradient.addColorStop(0, `hsl(${hue} 80% 60%)`);
        gradient.addColorStop(1, `hsl(${hue} 70% 45%)`);
        ctx.fillStyle = gradient;
        
        ctx.moveTo(0,0); 
        ctx.arc(0,0,R,start,end); 
        ctx.closePath(); 
        ctx.fill();
        
        // æ·»åŠ é‚Šæ¡†
        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        // ç¹ªè£½æ–‡å­—æ¨™ç±¤
        ctx.save();
        ctx.rotate(start + aPer/2);
        ctx.textAlign = 'right'; 
        ctx.textBaseline = 'middle';
        
        const item = eligibleItems[i];
        const name = (item?.name ?? `#${i+1}`);
        
        ctx.fillStyle = '#ffffff';
        ctx.font = 'bold 14px Inter, Noto Sans TC';
        // æ·»åŠ æ–‡å­—é™°å½±
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 1;
        ctx.shadowOffsetY = 1;
        
        // ç¹ªè£½åå­—
        const maxWidth = R - 50;
        const displayName = name.length > 8 ? name.substring(0, 7) + 'â€¦' : name;
        ctx.fillText(displayName, R-15, 0, maxWidth);
        
        // å¦‚æœæœ‰æ¬Šé‡ï¼Œé¡¯ç¤ºæ¬Šé‡
        if (item?.weight && item.weight > 1) {
          ctx.font = '10px Inter';
          ctx.fillStyle = 'rgba(255,255,255,0.6)';
          ctx.shadowBlur = 0;
          ctx.fillText(`Ã—${item.weight}`, R-15, 15);
        }
        
        ctx.restore();
      }
      
      // ç¹ªè£½ä¸­å¿ƒåœ“
      const centerGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, 50);
      centerGradient.addColorStop(0, '#1f2937');
      centerGradient.addColorStop(1, '#111827');
      ctx.beginPath(); 
      ctx.arc(0,0,50,0,Math.PI*2); 
      ctx.fillStyle = centerGradient;
      ctx.fill();
      
      // ä¸­å¿ƒæ–‡å­—
      ctx.fillStyle = '#f59e0b';
      ctx.font = 'bold 16px Inter';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.shadowColor = 'rgba(245,158,11,0.8)';
      ctx.shadowBlur = 8;
      ctx.fillText('SPIN', 0, 0);
      
      ctx.restore();
      
      // å¤–ç’°
      ctx.beginPath(); 
      ctx.arc(cx,cy,R+5,0,Math.PI*2); 
      ctx.strokeStyle = 'rgba(245,158,11,0.4)'; 
      ctx.lineWidth=8; 
      ctx.stroke();
    },
    spinTo(globalIndex, duration = 5000){
      console.log('ğŸ¯ === spinTo é–‹å§‹ ===', { 
        globalIndex, 
        duration, 
        currentSpinning: this.spinning,
        itemsCount: this.items.length,
        eligibleCount: this.items.filter(i => i.eligible !== false).length
      });
      
      if(this.spinning) {
        console.warn('âš ï¸ è½‰ç›¤æ­£åœ¨æ—‹è½‰ä¸­ï¼Œè·³é');
        return Promise.resolve();
      }
      
      // ç¢ºä¿å‹•ç•«IDè¢«æ¸…é™¤
      if(this.animId) {
        cancelAnimationFrame(this.animId);
        this.animId = null;
      }
      
      this.spinning = true;
      
      // åªè¨ˆç®—eligibleçš„åƒèˆ‡è€…
      const eligibleItems = this.items.filter(item => item.eligible !== false);
      const targetItem = this.items[globalIndex];
      const eligibleIndex = eligibleItems.findIndex(item => item.id === targetItem?.id);
      
      console.log('ğŸ“Š è½‰ç›¤è³‡è¨Š:', {
        totalItems: this.items.length,
        eligibleCount: eligibleItems.length,
        targetName: targetItem?.name,
        targetId: targetItem?.id,
        eligibleIndex
      });
      
      if(eligibleIndex === -1) {
        console.error('âŒ æ‰¾ä¸åˆ°ç›®æ¨™é …ç›®åœ¨eligibleåˆ—è¡¨ä¸­');
        this.spinning = false;
        return Promise.resolve();
      }
      
      const N = Math.max(1, eligibleItems.length);
      const aPer = Math.PI*2/N;
      
      // è¨ˆç®—ç›®æ¨™è§’åº¦
      const targetAngle = -Math.PI/2 - (eligibleIndex + 0.5)*aPer;
      const current = this.rotation % (Math.PI*2);
      let delta = targetAngle - current;
      
      // æ­£è¦åŒ–deltaåˆ°[-PI, PI]
      while (delta > Math.PI) delta -= Math.PI * 2;
      while (delta < -Math.PI) delta += Math.PI * 2;
      
      // æ·»åŠ é¡å¤–æ—‹è½‰åœˆæ•¸ (8-10åœˆ)
      const extraSpins = Math.PI * 2 * (8 + Math.random() * 2);
      const final = this.rotation + delta + extraSpins;
      
      console.log('ğŸ”„ è½‰ç›¤åƒæ•¸:', { 
        current: this.rotation.toFixed(2),
        targetAngle: targetAngle.toFixed(2),
        delta: delta.toFixed(2),
        extraSpins: `${(extraSpins/(Math.PI*2)).toFixed(1)}åœˆ`,
        final: final.toFixed(2),
        duration: `${duration}ms`
      });
      
      const startTime = performance.now();
      
      return new Promise((resolve) => {
        const easeOutCubic = (t) => {
          const t1 = 1 - t;
          return 1 - t1 * t1 * t1;
        };
        
        let frameCount = 0;
        const animate = (currentTime) => {
          const elapsed = currentTime - startTime;
          const progress = Math.min(1, elapsed / duration);
          
          this.rotation = current + (final - current) * easeOutCubic(progress);
          this.draw();
          
          frameCount++;
          if(frameCount % 30 === 0) {
            console.log(`ğŸ”„ æ—‹è½‰ä¸­... ${(progress * 100).toFixed(1)}%`);
          }
          
          if(progress < 1) {
            this.animId = requestAnimationFrame(animate);
          } else {
            console.log('âœ… === è½‰ç›¤å‹•ç•«å®Œæˆ === (ç¸½å¹€æ•¸:', frameCount, ')');
            this.spinning = false;
            this.rotation = final; // ç¢ºä¿æœ€å¾Œä½ç½®æ­£ç¢º
            this.draw();
            resolve();
          }
        };
        
        console.log('ğŸš€ å•Ÿå‹• requestAnimationFrame');
        this.animId = requestAnimationFrame(animate);
      });
    }
  }
});

const PhotoWall = defineComponent({ name: 'PhotoWall', template: '<div></div>' }); // ç§»é™¤ä½†ä¿ç•™ç©ºçµ„ä»¶é¿å…éŒ¯èª¤
const GridNine = defineComponent({ name: 'GridNine', template: '<div></div>' }); // ç§»é™¤ä½†ä¿ç•™ç©ºçµ„ä»¶é¿å…éŒ¯èª¤

/* ===================== Core Logic (RNG, weighting, draw) ===================== */
const Core = {
  randomCrypto(){ const b=new Uint32Array(1); crypto.getRandomValues(b); return (b[0]>>>0)/4294967296; },
  mulberry32(seed){ return function(){ let t=seed+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^= t + Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; } },
  async seededRng(seedStr){ const enc=new TextEncoder(); const buf=enc.encode(seedStr); const dig=await crypto.subtle.digest('SHA-256', buf); const v=new DataView(dig); const s=v.getUint32(0,false)||0x12345678; return Core.mulberry32(s); },
  weightedPick(pool, rng){
    const eligible = pool.filter(p=>p.eligible && p.weight>0);
    const total = eligible.reduce((s,p)=>s+p.weight,0);
    if(total<=0 || eligible.length===0) return null;
    let r = rng()*total; for(const p of eligible){ if((r -= p.weight) < 0) return p; }
    return eligible[eligible.length-1];
  }
};

/* ===================== App ===================== */
createApp({
  components:{ WheelCanvas, PhotoWall, GridNine },
  data(){
    return {
      i18nData,
      currentLanguage: localStorage.getItem('lottery.lang') || 'zh-TW',
      participants: [],
      drawCount: 1,
      noRepeat: true,
      rngMethod: localStorage.getItem('lottery.rng') || 'crypto',
      seedSalt: localStorage.getItem('lottery.salt') || '',
      publicSeed: localStorage.getItem('lottery.pubseed') || '',
      isDrawing:false,
      winners: [],
      drawLog: [],
      round: 0,

      /* æŠ½çå¡æ§ */
      currentSessionDrawn: 0, // æœ¬æ¬¡sessionå·²æŠ½å‡ºçš„ç¸½äººæ•¸
      maxDrawPerSession: 0, // æœ¬æ¬¡sessionæœ€å¤šå¯æŠ½äººæ•¸
      isSessionActive: false, // æ˜¯å¦æœ‰æ´»èºsession

      /* æ“´å……åŠŸèƒ½ */
      drawMode: 'single', // single: å–®æ¬¡æŠ½ç, batch: æ‰¹æ¬¡æŠ½ç, group: åˆ†çµ„æŠ½ç
      enableSound: true, // éŸ³æ•ˆé–‹é—œ
      animationSpeed: 'normal', // fast, normal, slow
      autoMode: false, // è‡ªå‹•é€£çºŒæŠ½ç
      showHistory: true, // é¡¯ç¤ºæ­·å²è¨˜éŒ„
      enableBlacklist: false, // å•Ÿç”¨é»‘åå–®
      blacklist: [], // é»‘åå–®åå–®
      blacklistInput: '', // é»‘åå–®è¼¸å…¥æ¡†
      prizeSettings: [], // çé …è¨­å®š
      currentPrizeIndex: 0, // ç•¶å‰çé …ç´¢å¼•
      showAdvancedSettings: false, // æ˜¯å¦é¡¯ç¤ºé€²éšè¨­å®š

      /* Roster Table */
      rosterTable: [
        { uid: Date.now() + '-0', name: '', weight: 1, nameError: false, weightError: false }
      ],
      rosterError: '',

      /* åŸºæœ¬è³‡è¨Š */
      lotteryPurpose: localStorage.getItem('lottery.purpose') || '',
      lotteryOptions: localStorage.getItem('lottery.options') || ''
    };
  },
  computed:{
    eligibleCount(){ return this.participants.filter(p=>p.eligible && p.weight>0).length; },
    canDraw() {
      // åˆ¤æ–·æ˜¯å¦å¯ä»¥æŠ½ç
      if(this.isDrawing || this.participants.length === 0 || this.drawCount < 1) return false;
      if(this.isSessionActive && this.currentSessionDrawn >= this.maxDrawPerSession) return false;
      return this.eligibleCount > 0;
    },
    sessionProgress() {
      if(!this.isSessionActive || this.maxDrawPerSession === 0) return 0;
      return Math.min(100, (this.currentSessionDrawn / this.maxDrawPerSession) * 100);
    },
    currentPrize() {
      if(this.prizeSettings.length === 0) return null;
      return this.prizeSettings[this.currentPrizeIndex] || null;
    }
  },
  watch:{
    currentLanguage(v){ localStorage.setItem('lottery.lang', v); },
    rngMethod(v){ localStorage.setItem('lottery.rng', v); },
    seedSalt(v){ localStorage.setItem('lottery.salt', v); },
    publicSeed(v){ localStorage.setItem('lottery.pubseed', v); },
    lotteryPurpose(v){ localStorage.setItem('lottery.purpose', v); },
    lotteryOptions(v){ localStorage.setItem('lottery.options', v); }
  },
  methods:{
    t(key){ return this.i18nData[this.currentLanguage]?.[key] || key; },
    
    // é–‹å§‹æ–°ä¸€è¼ªæŠ½ç
    startNewSession() {
      if(this.participants.length === 0) {
        alert('âŒ è«‹å…ˆç¢ºèªåƒèˆ‡è€…åå–®');
        return;
      }
      
      const maxDraw = parseInt(prompt(`è«‹è¼¸å…¥æœ¬æ¬¡æŠ½çè¦æŠ½å‡ºçš„ç¸½äººæ•¸ï¼š\nï¼ˆå¯æŠ½äººæ•¸ï¼š${this.eligibleCount}ï¼‰`, this.drawCount));
      
      if(!maxDraw || maxDraw < 1) {
        alert('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„æŠ½çäººæ•¸');
        return;
      }
      
      if(maxDraw > this.eligibleCount) {
        if(!confirm(`âš ï¸ è¨­å®šäººæ•¸(${maxDraw})å¤§æ–¼å¯æŠ½äººæ•¸(${this.eligibleCount})\n\næ˜¯å¦ç¹¼çºŒï¼Ÿï¼ˆå°‡ä»¥å¯æŠ½äººæ•¸ç‚ºæº–ï¼‰`)) {
          return;
        }
      }
      
      this.maxDrawPerSession = Math.min(maxDraw, this.eligibleCount);
      this.currentSessionDrawn = 0;
      this.isSessionActive = true;
      
      // æ¸…ç©ºæœ¬æ¬¡å¾—çè€…ï¼ˆé–‹å§‹æ–°ä¸€è¼ªï¼‰
      this.winners = [];
      
      // æ¢å¾©æ‰€æœ‰åƒèˆ‡è€…çš„æŠ½çè³‡æ ¼
      console.log('ğŸ”„ é‡ç½®æ‰€æœ‰åƒèˆ‡è€…ç‹€æ…‹...');
      this.participants.forEach((p, index) => {
        this.participants[index] = { ...p, eligible: true };
      });
      
      // å¼·åˆ¶è§¸ç™¼é‡ç¹ª
      this.$nextTick(() => {
        console.log('âœ… åƒèˆ‡è€…ç‹€æ…‹å·²é‡ç½®ï¼Œå¼·åˆ¶é‡ç¹ªè½‰ç›¤');
        if(this.$refs.visualRef) {
          this.$refs.visualRef.draw();
        }
      });
      
      alert(`âœ… å·²é–‹å§‹æ–°ä¸€è¼ªæŠ½ç\næœ¬è¼ªå°‡æŠ½å‡º ${this.maxDrawPerSession} äºº\n\næ‰€æœ‰åƒèˆ‡è€…ç‹€æ…‹å·²é‡ç½®`);
    },
    
    // çµæŸç•¶å‰session
    endSession() {
      if(!this.isSessionActive) return;
      
      // é¡¯ç¤ºæœ¬è¼ªæ‘˜è¦
      let summary = `ğŸ“Š æœ¬è¼ªæŠ½çæ‘˜è¦\n\n`;
      summary += `ç¸½åé¡ï¼š${this.maxDrawPerSession} äºº\n`;
      summary += `å·²æŠ½å‡ºï¼š${this.currentSessionDrawn} äºº\n`;
      summary += `å‰©é¤˜ï¼š${this.maxDrawPerSession - this.currentSessionDrawn} äºº\n\n`;
      
      if(this.winners.length > 0) {
        summary += `ğŸ‰ æœ¬è¼ªå¾—çè€…ï¼š\n`;
        this.winners.forEach(w => {
          summary += `  â€¢ ${w.prize ? '['+w.prize+'] ' : ''}${w.name}\n`;
        });
      }
      
      summary += `\nç¢ºå®šè¦çµæŸæœ¬è¼ªæŠ½çå—ï¼Ÿ`;
      
      if(confirm(summary)) {
        this.isSessionActive = false;
        this.currentSessionDrawn = 0;
        this.maxDrawPerSession = 0;
        this.winners = []; // æ¸…ç©ºæœ¬æ¬¡å¾—çè€…
        alert('âœ… å·²çµæŸæœ¬è¼ªæŠ½ç\n\næ‰€æœ‰è¨˜éŒ„å·²ä¿å­˜è‡³ã€ŒæŠ½çç´€éŒ„ã€å€å¡Š');
      }
    },
    
    // é‡ç½®sessionä¸¦é‡æ–°é–‹å§‹
    resetAndRestart() {
      // é¡¯ç¤ºå®Œæˆç¸½çµ
      let summary = `ğŸŠ æ­å–œå®Œæˆæœ¬è¼ªæŠ½çï¼\n\n`;
      summary += `æœ¬è¼ªå·²æŠ½å‡º ${this.currentSessionDrawn}/${this.maxDrawPerSession} äºº\n\n`;
      
      if(this.winners.length > 0) {
        summary += `ğŸ† å¾—çåå–®ï¼š\n`;
        this.winners.forEach((w, i) => {
          summary += `  ${i+1}. ${w.prize ? '['+w.prize+'] ' : ''}${w.name}\n`;
        });
        summary += `\n`;
      }
      
      summary += `æ˜¯å¦é–‹å§‹ä¸‹ä¸€è¼ªæŠ½çï¼Ÿ`;
      
      if(confirm(summary)) {
        this.isSessionActive = false;
        this.currentSessionDrawn = 0;
        this.maxDrawPerSession = 0;
        this.winners = []; // æ¸…ç©ºæœ¬æ¬¡å¾—çè€…
        this.startNewSession();
      } else {
        // å¦‚æœä¸ç¹¼çºŒï¼Œä¹Ÿè¦æ¸…ç†ç‹€æ…‹
        this.isSessionActive = false;
        this.currentSessionDrawn = 0;
        this.maxDrawPerSession = 0;
        this.winners = [];
        alert('âœ… å·²çµæŸæŠ½ç\n\næ‰€æœ‰è¨˜éŒ„å·²ä¿å­˜');
      }
    },
    
    // æ·»åŠ åˆ°é»‘åå–®
    addToBlacklist(name) {
      if(!this.blacklist.includes(name)) {
        this.blacklist.push(name);
        // å¾åƒèˆ‡è€…ä¸­ç§»é™¤
        const idx = this.participants.findIndex(p => p.name === name);
        if(idx >= 0) {
          this.participants[idx].eligible = false;
        }
      }
    },
    
    // å¾é»‘åå–®ç§»é™¤
    removeFromBlacklist(name) {
      const idx = this.blacklist.indexOf(name);
      if(idx >= 0) {
        this.blacklist.splice(idx, 1);
      }
    },
    
    // æ·»åŠ çé …è¨­å®š
    addPrizeSetting() {
      const name = prompt('è«‹è¼¸å…¥çé …åç¨±ï¼š', `${['ç‰¹ç', 'é ­ç', 'è²³ç', 'åƒç', 'è‚†ç'][this.prizeSettings.length] || 'çé …'}`);
      if(!name) return;
      
      const count = parseInt(prompt('è«‹è¼¸å…¥è©²çé …åé¡ï¼š', '1'));
      if(!count || count < 1) return;
      
      this.prizeSettings.push({
        id: Date.now(),
        name: name,
        count: count,
        drawn: 0,
        winners: []
      });
    },
    
    // åˆªé™¤çé …
    removePrizeSetting(id) {
      const idx = this.prizeSettings.findIndex(p => p.id === id);
      if(idx >= 0) {
        this.prizeSettings.splice(idx, 1);
        if(this.currentPrizeIndex >= this.prizeSettings.length) {
          this.currentPrizeIndex = Math.max(0, this.prizeSettings.length - 1);
        }
      }
    },
    
    // ä¿å­˜è¨­å®š
    saveSettings() {
      const settings = {
        drawMode: this.drawMode,
        enableSound: this.enableSound,
        animationSpeed: this.animationSpeed,
        autoMode: this.autoMode,
        showHistory: this.showHistory,
        enableBlacklist: this.enableBlacklist,
        blacklist: this.blacklist,
        prizeSettings: this.prizeSettings,
        drawCount: this.drawCount,
        noRepeat: this.noRepeat
      };
      
      const blob = new Blob([JSON.stringify(settings, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `lottery_settings_${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    },
    
    // è¼‰å…¥è¨­å®š
    loadSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const settings = JSON.parse(e.target.result);
            this.drawMode = settings.drawMode || 'single';
            this.enableSound = settings.enableSound !== false;
            this.animationSpeed = settings.animationSpeed || 'normal';
            this.autoMode = settings.autoMode || false;
            this.showHistory = settings.showHistory !== false;
            this.enableBlacklist = settings.enableBlacklist || false;
            this.blacklist = settings.blacklist || [];
            this.prizeSettings = settings.prizeSettings || [];
            this.drawCount = settings.drawCount || 1;
            this.noRepeat = settings.noRepeat !== false;
            alert('âœ… è¨­å®šå·²è¼‰å…¥');
          } catch(err) {
            alert('âŒ è¼‰å…¥è¨­å®šå¤±æ•—ï¼š' + err.message);
          }
        };
        reader.readAsText(file);
      };
      input.click();
    },
    
    // æ’­æ”¾æ…¶ç¥éŸ³æ•ˆ
    playCelebrationSound() {
      try {
        // ä½¿ç”¨Web Audio APIå‰µå»ºç°¡å–®çš„æ…¶ç¥éŸ³æ•ˆ
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const duration = 0.3;
        
        // å‰µå»ºä¸‰å€‹éŸ³ç¬¦çš„å’Œå¼¦æ•ˆæœ (C5, E5, G5)
        const frequencies = [523.25, 659.25, 783.99];
        
        frequencies.forEach((freq, index) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = freq;
          oscillator.type = 'sine';
          
          // è¨­ç½®éŸ³é‡åŒ…çµ¡
          const now = audioContext.currentTime;
          gainNode.gain.setValueAtTime(0, now);
          gainNode.gain.linearRampToValueAtTime(0.15, now + 0.01);
          gainNode.gain.exponentialRampToValueAtTime(0.01, now + duration);
          
          oscillator.start(now + index * 0.1);
          oscillator.stop(now + index * 0.1 + duration);
        });
      } catch(e) {
        console.warn('éŸ³æ•ˆæ’­æ”¾å¤±æ•—:', e);
      }
    },
    
    // æ…¶ç¥å‹•ç•«
    showCelebration(winnerName, silent = false) {
      // æ’­æ”¾éŸ³æ•ˆ
      if(this.enableSound && !silent) {
        this.playCelebrationSound();
      }
      
      // å‰µå»ºæ…¶ç¥è¦†è“‹å±¤
      const overlay = document.createElement('div');
      overlay.className = 'celebration-overlay';
      overlay.style.cssText = 'position: fixed; inset: 0; z-index: 9999; pointer-events: none;';
      
      // æ·»åŠ å½©ç´™æ•ˆæœ
      for(let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = `${Math.random() * 100}%`;
        confetti.style.animationDelay = `${Math.random() * 0.5}s`;
        confetti.style.animationDuration = `${2 + Math.random() * 2}s`;
        
        const colors = ['#f59e0b', '#ec4899', '#8b5cf6', '#3b82f6', '#10b981'];
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.width = `${Math.random() * 10 + 5}px`;
        confetti.style.height = confetti.style.width;
        
        overlay.appendChild(confetti);
      }
      
      // æ·»åŠ ä¸­çè€…é€šçŸ¥
      const notice = document.createElement('div');
      notice.className = 'winner-modal';
      notice.style.cssText = `
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #f59e0b 0%, #ec4899 100%);
        padding: 2rem 3rem;
        border-radius: 1.5rem;
        box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        color: white;
        font-size: 2rem;
        font-weight: bold;
        text-align: center;
        z-index: 10000;
      `;
      notice.innerHTML = `
        <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ‰</div>
        <div>æ­å–œ</div>
        <div style="font-size: 2.5rem; margin: 1rem 0;">${winnerName}</div>
        <div style="font-size: 1.5rem;">ä¸­çäº†ï¼</div>
      `;
      
      overlay.appendChild(notice);
      document.body.appendChild(overlay);
      
      // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
      setTimeout(() => {
        overlay.remove();
      }, 3000);
    },
    
    addRow() {
      this.rosterTable.push({ 
        uid: Date.now() + '-' + Math.random().toString(36).slice(2,6), 
        name: '', 
        weight: 1, 
        nameError: false, 
        weightError: false 
      });
    },
    
    removeRow(idx) {
      this.rosterTable.splice(idx, 1);
      this.updateRosterError();
    },
    
    validateName(idx) {
      const p = this.rosterTable[idx];
      p.nameError = !p.name.trim();
      this.updateRosterError();
    },
    
    validateWeight(idx) {
      const p = this.rosterTable[idx];
      const w = Number(p.weight);
      p.weightError = !(Number.isInteger(w) && w > 0);
      this.updateRosterError();
    },
    
    updateRosterError() {
      this.rosterError = '';
      const hasEmpty = this.rosterTable.some(p => !p.name.trim());
      const hasInvalidWeight = this.rosterTable.some(p => {
        const w = Number(p.weight);
        return !(Number.isInteger(w) && w > 0);
      });
      
      if (hasEmpty) { 
        this.rosterError = 'å§“åä¸å¯ç©ºç™½'; 
      } else if (hasInvalidWeight) { 
        this.rosterError = 'æ¬Šé‡å¿…é ˆç‚ºæ­£æ•´æ•¸'; 
      }
    },
    
    clearRoster() {
      this.rosterTable = [{ 
        uid: Date.now() + '-0', 
        name: '', 
        weight: 1, 
        nameError: false, 
        weightError: false 
      }];
      this.rosterError = '';
      this.participants = [];
      this.winners = [];
    },
    
    batchPaste() {
      const text = prompt('è«‹è²¼ä¸Šåå–®ï¼Œæ¯è¡Œæ ¼å¼ï¼šå§“å,æ¬Šé‡ï¼ˆæ¬Šé‡å¯çœç•¥ï¼Œé è¨­ç‚º1ï¼‰\n\nç¯„ä¾‹ï¼š\nç‹å°æ˜,3\næå°è¯\né™³å¤§åŒ,2');
      if (!text) return;
      
      const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      this.rosterTable = lines.map((line, idx) => {
        const parts = line.split(/[\t,\|]+/).map(s=>s.trim());
        const name = parts[0] || '';
        const weight = parts[1] ? Number(parts[1]) : 1;
        
        return {
          uid: Date.now() + '-' + idx,
          name: name,
          weight: weight > 0 ? weight : 1,
          nameError: !name,
          weightError: !(Number.isInteger(weight) && weight > 0)
        };
      });
      this.updateRosterError();
    },
    
    loadSample() {
      const samples = {
        'zh-TW': [
          { name: 'ç‹å°æ˜', weight: 3 },
          { name: 'æå°è¯', weight: 1 },
          { name: 'é™³å¤§åŒ', weight: 2 },
          { name: 'å¼µç¾éº—', weight: 1 },
          { name: 'æ—å¿—æ˜', weight: 2 }
        ],
        'zh-CN': [
          { name: 'å¼ ä¸‰', weight: 3 },
          { name: 'æå››', weight: 1 },
          { name: 'ç‹äº”', weight: 2 },
          { name: 'èµµå…­', weight: 1 },
          { name: 'é’±ä¸ƒ', weight: 2 }
        ],
        'en': [
          { name: 'Alice', weight: 3 },
          { name: 'Bob', weight: 1 },
          { name: 'Charlie', weight: 2 },
          { name: 'Diana', weight: 1 },
          { name: 'Eve', weight: 2 }
        ],
        'ja': [
          { name: 'ä½è—¤', weight: 3 },
          { name: 'éˆ´æœ¨', weight: 1 },
          { name: 'ç”°ä¸­', weight: 2 },
          { name: 'é«˜æ©‹', weight: 1 },
          { name: 'æ¸¡è¾º', weight: 2 }
        ]
      };
      
      const sample = samples[this.currentLanguage] || samples['zh-TW'];
      this.rosterTable = sample.map((p, idx) => ({
        uid: Date.now() + '-' + idx,
        name: p.name,
        weight: p.weight,
        nameError: false,
        weightError: false
      }));
      this.rosterError = '';
    },
    
    parseParticipants() {
      if (this.rosterError) {
        alert('è«‹ä¿®æ­£åå–®éŒ¯èª¤å¾Œå†ç¢ºèª');
        return;
      }
      
      if (this.rosterTable.length === 0) {
        alert('è«‹è‡³å°‘æ–°å¢ä¸€ä½åƒèˆ‡è€…');
        return;
      }
      
      this.participants = this.rosterTable
        .filter(p => p.name.trim() && Number.isInteger(Number(p.weight)) && Number(p.weight) > 0)
        .filter(p => !this.enableBlacklist || !this.blacklist.includes(p.name.trim())) // éæ¿¾é»‘åå–®
        .map((p, idx) => ({
          id: `${Date.now()}_${idx}_${Math.random().toString(36).slice(2,7)}`,
          name: p.name.trim(),
          weight: Number(p.weight),
          eligible: true
        }));
      
      if (this.participants.length === 0) {
        alert('æ²’æœ‰æœ‰æ•ˆçš„åƒèˆ‡è€…');
        return;
      }
      
      this.winners = [];
      this.round = 0;
      
      // é¡¯ç¤ºç¢ºèªè¨Šæ¯
      let message = `âœ… å·²ç¢ºèª ${this.participants.length} ä½åƒèˆ‡è€…\nç¸½æ¬Šé‡ï¼š${this.participants.reduce((s,p)=>s+p.weight, 0)}`;
      if(this.enableBlacklist && this.blacklist.length > 0) {
        const filtered = this.rosterTable.filter(p => this.blacklist.includes(p.name.trim())).length;
        if(filtered > 0) {
          message += `\nå·²éæ¿¾é»‘åå–®ï¼š${filtered} äºº`;
        }
      }
      alert(message);
    },
    
    resetEligibility(){ 
      this.participants = this.participants.map(p=>({ ...p, eligible:true })); 
      alert('âœ… å·²æ¢å¾©æ‰€æœ‰åƒèˆ‡è€…çš„æŠ½çè³‡æ ¼');
    },
    
    generateSalt(){ 
      const b=new Uint8Array(16); 
      crypto.getRandomValues(b); 
      this.seedSalt = Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join(''); 
    },

    async drawWinners(){
      if(this.participants.length===0) {
        alert('âŒ è«‹å…ˆç¢ºèªåƒèˆ‡è€…åå–®');
        return;
      }
      
      if(this.drawCount<1) {
        alert('âŒ æŠ½å–äººæ•¸å¿…é ˆå¤§æ–¼0');
        return;
      }
      
      if(this.eligibleCount === 0) {
        alert('âŒ æ²’æœ‰å¯æŠ½çš„åƒèˆ‡è€…\n\nè«‹é»æ“Šã€Œæ¢å¾©æ‰€æœ‰è³‡æ ¼ã€æŒ‰éˆ•é‡ç½®');
        return;
      }
      
      // æª¢æŸ¥sessionç‹€æ…‹
      if(!this.isSessionActive) {
        if(!confirm('å°šæœªé–‹å§‹æŠ½çè¼ªæ¬¡\n\næ˜¯å¦ç«‹å³é–‹å§‹æ–°ä¸€è¼ªæŠ½çï¼Ÿ')) {
          return;
        }
        this.startNewSession();
        if(!this.isSessionActive) return; // å¦‚æœç”¨æˆ¶å–æ¶ˆäº†
      }
      
      // æª¢æŸ¥æ˜¯å¦å·²é”æœ¬è¼ªä¸Šé™
      if(this.currentSessionDrawn >= this.maxDrawPerSession) {
        alert(`âŒ æœ¬è¼ªæŠ½çå·²é”ä¸Šé™\n\nå·²æŠ½å‡ºï¼š${this.currentSessionDrawn}/${this.maxDrawPerSession} äºº\n\nè«‹é–‹å§‹æ–°ä¸€è¼ªæŠ½ç`);
        return;
      }
      
      // è¨ˆç®—æœ¬æ¬¡å¯æŠ½äººæ•¸
      const remainingInSession = this.maxDrawPerSession - this.currentSessionDrawn;
      const actualDrawCount = Math.min(this.drawCount, remainingInSession, this.eligibleCount);
      
      if(this.drawCount > remainingInSession) {
        if(!confirm(`âš ï¸ æœ¬æ¬¡è¨­å®šæŠ½å–${this.drawCount}äººï¼Œä½†æœ¬è¼ªåƒ…å‰©${remainingInSession}å€‹åé¡\n\nå°‡æŠ½å‡º${actualDrawCount}äººï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ`)) {
          return;
        }
      }
      
      this.isDrawing = true;
      
      try{
        let rng = Core.randomCrypto;
        let methodLabel = 'Crypto';

        const winnersThisRound=[]; 
        const N = actualDrawCount;
        
        // å›ºå®šè½‰ç›¤æ—‹è½‰æ™‚é–“ç‚º5ç§’
        const spinDuration = 5000;
        const pauseBetween = 3200;
        
        for(let i=0;i<N;i++){
          console.log(`
ğŸ° ========== ç¬¬ ${i+1}/${N} æ¬¡æŠ½ç ==========`);
          
          const pick = Core.weightedPick(this.participants, rng);
          if(!pick) break;
          
          console.log('ğŸ¯ æŠ½ä¸­:', pick.name);
          winnersThisRound.push(pick);
          
          // ã€é—œéµã€‘å…ˆä¸ä¿®æ”¹ eligibleï¼Œç­‰è½‰ç›¤å®Œæˆå¾Œå†æ”¹
          const globalIndex = this.participants.findIndex(p=>p.id===pick.id);
          console.log('ğŸª æº–å‚™æ—‹è½‰è½‰ç›¤...', { 
            globalIndex, 
            spinDuration,
            pickName: pick.name,
            pickId: pick.id
          });
          
          // æª¢æŸ¥ visualRef æ˜¯å¦å­˜åœ¨
          if(!this.$refs.visualRef) {
            console.error('âŒ visualRef ä¸å­˜åœ¨ï¼');
            alert('éŒ¯èª¤ï¼šè½‰ç›¤çµ„ä»¶æœªåˆå§‹åŒ–');
            return;
          }
          
          // ========== æ­¥é©Ÿ1: è½‰ç›¤æ—‹è½‰å‹•ç•«ï¼ˆ5ç§’ï¼‰ ==========
          console.log('ğŸ”„ [æ­¥é©Ÿ1] è½‰ç›¤é–‹å§‹æ—‹è½‰...');
          await this.$refs.visualRef.spinTo(globalIndex, spinDuration);
          console.log('âœ… [æ­¥é©Ÿ1å®Œæˆ] è½‰ç›¤æ—‹è½‰çµæŸ');
          
          // ========== æ­¥é©Ÿ2: è½‰ç›¤åœç©©å¾Œï¼Œä¿®æ”¹ eligible ==========
          console.log('ğŸ”„ [æ­¥é©Ÿ2] ç­‰å¾…è½‰ç›¤å®Œå…¨åœç©©...');
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // ç¾åœ¨æ‰æ¨™è¨˜ç‚ºä¸å¯æŠ½ï¼ˆè½‰ç›¤å·²ç¶“åœæ­¢äº†ï¼‰
          if(this.noRepeat){ 
            const idx = this.participants.findIndex(p=>p.id===pick.id); 
            if(idx>=0) {
              console.log('ğŸš« è¨­å®š eligible=false:', this.participants[idx].name);
              this.participants[idx].eligible = false;
            }
          }
          
          console.log('âœ… [æ­¥é©Ÿ2å®Œæˆ] åƒèˆ‡è€…ç‹€æ…‹å·²æ›´æ–°');
          
          // ========== æ­¥é©Ÿ3: é–ƒå…‰æ•ˆæœ ==========
          console.log('ğŸ”„ [æ­¥é©Ÿ3] æ·»åŠ é–ƒå…‰æ•ˆæœ...');
          const wheelContainer = this.$refs.wheelContainer;
          if(wheelContainer) {
            wheelContainer.classList.add('wheel-glow');
            setTimeout(() => wheelContainer.classList.remove('wheel-glow'), 800);
          }
          
          await new Promise(resolve => setTimeout(resolve, 300));
          console.log('âœ… [æ­¥é©Ÿ3å®Œæˆ] é–ƒå…‰æ•ˆæœå®Œæˆ');
          
          // ========== æ­¥é©Ÿ4: é¡¯ç¤ºæ…¶ç¥å‹•ç•« ==========
          console.log('ğŸ”„ [æ­¥é©Ÿ4] é¡¯ç¤ºæ…¶ç¥å‹•ç•«:', pick.name);
          if(this.enableSound) {
            this.showCelebration(pick.name);
          } else {
            this.showCelebration(pick.name, true); // éœéŸ³æ¨¡å¼
          }
          
          // å¢åŠ è¼ªæ¬¡
          this.round += 1;
          this.currentSessionDrawn += 1;
          
          // è¨˜éŒ„å¾—çè€…
          const winnerData = { 
            name: pick.name, 
            weight: pick.weight, 
            round: this.round,
            prize: this.currentPrize ? this.currentPrize.name : ''
          };
          this.winners.push(winnerData);
          
          // å¦‚æœæœ‰çé …è¨­å®šï¼Œè¨˜éŒ„åˆ°çé …ä¸­
          if(this.currentPrize) {
            this.currentPrize.winners.push(pick.name);
            this.currentPrize.drawn += 1;
            
            // å¦‚æœè©²çé …å·²æŠ½å®Œï¼Œè‡ªå‹•åˆ‡æ›åˆ°ä¸‹ä¸€å€‹çé …
            if(this.currentPrize.drawn >= this.currentPrize.count) {
              if(this.currentPrizeIndex < this.prizeSettings.length - 1) {
                this.currentPrizeIndex += 1;
              }
            }
          }
          
          // å¦‚æœè¦æŠ½å¤šå€‹ï¼Œä¸­é–“ç¨ä½œåœé “ï¼ˆç­‰å¾…æ…¶ç¥å‹•ç•«ï¼‰
          if(i < N-1) {
            await new Promise(resolve => setTimeout(resolve, pauseBetween));
          }
        }

        // è¨˜éŒ„åˆ°æŠ½çç´€éŒ„
        if(winnersThisRound.length>0){
          const ts = new Date();
          this.drawLog.unshift({ 
            time: ts.toLocaleString('zh-TW', { 
              year: 'numeric', 
              month: '2-digit', 
              day: '2-digit', 
              hour: '2-digit', 
              minute: '2-digit', 
              second: '2-digit' 
            }), 
            round: this.round, 
            winners: winnersThisRound.map(w=>w.name),
            prize: this.currentPrize ? this.currentPrize.name : '',
            sessionProgress: `${this.currentSessionDrawn}/${this.maxDrawPerSession}`
          });
        }
        
        // æª¢æŸ¥æ˜¯å¦å®Œæˆæœ¬è¼ª
        if(this.currentSessionDrawn >= this.maxDrawPerSession) {
          setTimeout(() => {
            let msg = `ğŸŠ æœ¬è¼ªæŠ½çå·²å®Œæˆï¼\n\n`;
            msg += `ğŸ“Š çµ±è¨ˆï¼š${this.currentSessionDrawn}/${this.maxDrawPerSession} äºº\n\n`;
            msg += `ğŸ† å¾—çåå–®ï¼š\n`;
            this.winners.forEach((w, i) => {
              msg += `  ${i+1}. ${w.prize ? '['+w.prize+'] ' : ''}${w.name}\n`;
            });
            msg += `\nğŸ’¡ æç¤ºï¼šé»æ“Šã€ŒğŸ”„ é‡æ–°é–‹å§‹ã€å¯ä»¥é–‹å•Ÿä¸‹ä¸€è¼ªæŠ½ç`;
            alert(msg);
          }, 500);
        }
        
      } catch(error) {
        console.error('æŠ½çéç¨‹ç™¼ç”ŸéŒ¯èª¤:', error);
        alert('âŒ æŠ½çéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦');
      } finally { 
        this.isDrawing=false; 
      }
    },

    exportLog(){
      const payload = { 
        purpose: this.lotteryPurpose,
        options: this.lotteryOptions,
        lang: this.currentLanguage, 
        rngMethod: this.rngMethod, 
        seedSalt: this.seedSalt, 
        publicSeed: this.publicSeed, 
        noRepeat: this.noRepeat,
        roster: this.participants.map(p=>({
          name: p.name, 
          weight: p.weight, 
          eligible: p.eligible
        })), 
        winners: this.winners,
        log: this.drawLog,
        exportTime: new Date().toISOString()
      };
      
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); 
      const a = document.createElement('a'); 
      const fileName = `lottery_${this.lotteryPurpose || 'record'}_${Date.now()}.json`;
      a.href = url; 
      a.download = fileName; 
      a.click(); 
      URL.revokeObjectURL(url);
    },
    
    exportXLSX() {
      const now = new Date();
      const sheetData = [
        ['æŠ½çä¸»é¡Œ', this.lotteryPurpose || 'æœªå¡«å¯«'],
        ['çé …èªªæ˜', this.lotteryOptions || 'æœªå¡«å¯«'],
        ['æŠ½çæ™‚é–“', now.toLocaleString('zh-TW')],
        ['éš¨æ©Ÿæ¨¡å¼', 'Cryptoï¼ˆåŠ å¯†ç­‰ç´šï¼‰'],
        ['ç¸½åƒèˆ‡äººæ•¸', this.participants.length],
        ['ç¸½æŠ½çè¼ªæ¬¡', this.round],
        [],
        ['è¼ªæ¬¡', 'æ™‚é–“', 'å¾—çè€…']
      ];
      
      // æ¯ç­†ç´€éŒ„
      this.drawLog.slice().reverse().forEach(row => {
        sheetData.push([
          row.round,
          row.time,
          row.winners.join(', ')
        ]);
      });
      
      // åƒèˆ‡è€…ç‹€æ…‹
      sheetData.push([]);
      sheetData.push(['åƒèˆ‡è€…åå–®', 'æ¬Šé‡', 'ç‹€æ…‹']);
      this.participants.forEach(p => {
        sheetData.push([
          p.name,
          p.weight,
          p.eligible ? 'å¯æŠ½' : 'å·²ä¸­ç'
        ]);
      });
      
      // ç”¢ç”Ÿ XLSX
      const ws = XLSX.utils.aoa_to_sheet(sheetData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'æŠ½çç´€éŒ„');
      
      const fileName = `lottery_${this.lotteryPurpose || 'record'}_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.xlsx`;
      XLSX.writeFile(wb, fileName);
    }
  },
  
  mounted(){ 
    if(!this.seedSalt) this.generateSalt(); 
  }
}).mount('#app');
</script>
</body>
</html>
