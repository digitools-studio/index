<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æŠ½çå¼•æ“ï½œLottery Engine (Vue 3 + i18n)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg: #0b0f1a; --panel: rgba(255,255,255,.06); --panel2: rgba(255,255,255,.1); --border: rgba(255,255,255,.12); }
    html,body{ height:100%; }
    body{ background: radial-gradient(1200px 600px at 10% 10%, #11203a 0%, transparent 60%),
                    radial-gradient(1200px 600px at 90% 90%, #1b163a 0%, transparent 60%),
                    var(--bg);
          color: #e5e7eb; font-family: Inter, 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; }
    .glass{ background: var(--panel); backdrop-filter: blur(10px); border:1px solid var(--border); }
    .glass-2{ background: var(--panel2); backdrop-filter: blur(10px); border:1px solid var(--border); }
    .btn{ transition: all .2s ease; }
    .btn:hover{ transform: translateY(-1px); }
    .mono{ font-variant-numeric: tabular-nums; }

    /* Pointer arrow for the wheel */
    .pointer{ width:0; height:0; border-left:10px solid transparent; border-right:10px solid transparent; border-bottom:16px solid #f59e0b; }

    /* PhotoWall animations */
    .wall-rotate{ animation: wallSpin 20s linear infinite; transform-style: preserve-3d; }
    @keyframes wallSpin{ from{ transform: rotateY(0deg) } to{ transform: rotateY(360deg) } }
    .card-spotlight{ animation: spotlight .9s ease both; }
    @keyframes spotlight{ 0%{ transform: translateZ(0) scale(1); box-shadow: 0 0 0 rgba(245,158,11,0);} 60%{ transform: translateZ(40px) scale(1.07); box-shadow: 0 20px 60px rgba(245,158,11,.35);} 100%{ transform: translateZ(20px) scale(1.02);} }

    /* GridNine highlight */
    .cell-highlight{ animation: pulse .6s ease-in-out; }
    @keyframes pulse{ 0%{ box-shadow:0 0 0 0 rgba(245,158,11,.0);} 50%{ box-shadow:0 0 0 6px rgba(245,158,11,.25);} 100%{ box-shadow:0 0 0 0 rgba(245,158,11,.0);} }

    .scrollbar-thin::-webkit-scrollbar{ height:6px; width:6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb{ background:#374151; border-radius:6px; }
  </style>
</head>
<body>
<div id="app" class="max-w-7xl mx-auto px-4 py-6 md:py-10">
  <!-- Header -->
  <header class="flex flex-col md:flex-row md:items-center gap-4 md:gap-6 mb-6">
    <div class="flex-1 flex items-center gap-3">
      <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-amber-400 to-pink-500"></div>
      <div>
        <h1 class="text-xl md:text-2xl font-bold tracking-tight">{{ t('title') }}</h1>
        <p class="text-sm text-gray-400">{{ t('subtitle') }}</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <select v-model="currentLanguage" class="glass px-3 py-2 rounded-lg text-sm">
        <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
        <option value="zh-CN">ç®€ä½“ä¸­æ–‡</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
      </select>
      <a class="glass px-3 py-2 rounded-lg text-sm hover:bg-white/10" href="#" @click.prevent="loadSample">{{ t('btn_sample') }}</a>
    </div>
  </header>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Left: Controls -->
    <section class="glass rounded-2xl p-5 md:p-6">
      <!-- Mode Tabs -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button class="btn px-3 py-2 rounded-lg border border-white/10" :class="mode==='wheel' ? 'bg-amber-500 text-black' : 'glass-2'" @click="mode='wheel'">ğŸŒ€ {{ t('tab_wheel') }}</button>
        <button class="btn px-3 py-2 rounded-lg border border-white/10" :class="mode==='wall' ? 'bg-amber-500 text-black' : 'glass-2'" @click="mode='wall'">ğŸ–¼ï¸ {{ t('tab_wall') }}</button>
        <button class="btn px-3 py-2 rounded-lg border border-white/10" :class="mode==='grid' ? 'bg-amber-500 text-black' : 'glass-2'" @click="mode='grid'">#ï¸âƒ£ {{ t('tab_grid') }}</button>
      </div>

      <!-- Roster -->
      <div>
        <label class="block text-sm text-gray-300 mb-1">{{ t('roster_label') }}</label>
        <div class="space-y-2">
          <div v-for="(p, idx) in rosterTable" :key="p.uid" class="flex gap-2 items-center">
            <input
              v-model="p.name"
              @input="validateName(idx)"
              :class="['glass-2 flex-1 rounded-lg p-2 text-sm', p.nameError ? 'border border-red-400' : '']"
              placeholder="è¼¸å…¥äººå“¡åå­—æˆ–åŒ¿å"
            />
            <input
              v-model.number="p.weight"
              @input="validateWeight(idx)"
              type="number"
              min="1"
              :class="['glass-2 w-20 rounded-lg p-2 text-sm text-center', p.weightError ? 'border border-red-400' : '']"
              placeholder="1"
            />
            <button class="btn px-2 py-1 rounded bg-red-500 text-white" @click="removeRow(idx)" v-if="rosterTable.length>1">âœ•</button>
          </div>
          <div v-if="rosterError" class="text-red-400 text-xs">{{ rosterError }}</div>
          <div class="flex gap-2 mt-2 flex-wrap">
            <button class="btn glass-2 px-3 py-2 rounded-lg" @click="addRow">+ æ–°å¢åƒè³½è€…</button>
            <button class="btn glass-2 px-3 py-2 rounded-lg" @click="batchPaste">{{ t('btn_parse') }}ï¼ˆæ‰¹æ¬¡è²¼ä¸Šï¼‰</button>
            <button class="btn glass-2 px-3 py-2 rounded-lg" @click="clearRoster">{{ t('btn_clear') }}</button>
            <button class="btn glass-2 px-3 py-2 rounded-lg" @click="loadSample">{{ t('btn_sample') }}</button>
            <!-- æ–°å¢ç¢ºèªåå–®æŒ‰éˆ• -->
            <button class="btn bg-amber-500 text-black px-3 py-2 rounded-lg" @click="parseParticipants" :disabled="!!rosterError">ç¢ºèªåå–®</button>
          </div>
        </div>
      </div>

      <hr class="border-white/10 my-5" />

      <!-- Options -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm text-gray-300">{{ t('draw_count') }}</label>
          <input type="number" min="1" v-model.number="drawCount" class="glass-2 w-full mt-1 rounded-lg p-2 text-sm" />
        </div>
        <label class="flex items-center gap-2 mt-5 md:mt-8">
          <input type="checkbox" v-model="noRepeat" class="rounded" />
          <span class="text-sm text-gray-300">{{ t('no_repeat') }}</span>
        </label>
      </div>

      <div class="mt-4">
        <p class="text-sm text-gray-300 mb-2">{{ t('rng_title') }}</p>
        <div class="flex flex-col gap-1">
          <label class="flex items-center gap-2"><input type="radio" value="crypto" v-model="rngMethod"/> <span class="text-sm">{{ t('rng_crypto') }}</span></label>
          <label class="flex items-center gap-2"><input type="radio" value="seeded" v-model="rngMethod"/> <span class="text-sm">{{ t('rng_seeded') }}</span></label>
          <label class="flex items-center gap-2 opacity-80"><input type="radio" value="math" v-model="rngMethod"/> <span class="text-sm">{{ t('rng_math') }}</span></label>
        </div>
        <div v-if="rngMethod==='seeded'" class="mt-3 glass-2 p-3 rounded-xl">
          <div class="flex items-center justify-between gap-2 mb-2">
            <label class="text-sm text-gray-300">{{ t('seed_salt') }}</label>
            <button class="btn px-2 py-1 rounded-md glass" @click="generateSalt">{{ t('btn_gen_salt') }}</button>
          </div>
          <input v-model="seedSalt" class="w-full glass rounded-lg p-2 text-sm mb-2"/>
          <label class="text-sm text-gray-300">{{ t('seed_public') }}</label>
          <input v-model="publicSeed" :placeholder="t('seed_public_ph')" class="w-full glass rounded-lg p-2 text-sm"/>
          <p class="text-xs text-gray-400 mt-2">{{ t('seed_tip') }}</p>
        </div>
      </div>

      <div class="mt-5 flex flex-wrap gap-3">
        <button class="btn bg-amber-500 text-black px-4 py-2 rounded-xl disabled:opacity-60" :disabled="isDrawing || participants.length===0 || drawCount<1" @click="drawWinners">
          {{ isDrawing ? t('btn_drawing') : t('btn_draw') }}
        </button>
        <button class="btn glass-2 px-4 py-2 rounded-xl" @click="resetEligibility">{{ t('btn_reset_eligibility') }}</button>
        <button class="btn glass-2 px-4 py-2 rounded-xl" :disabled="drawLog.length===0" @click="exportLog">{{ t('btn_export') }}</button>
        <!-- æ–°å¢ XLSX åŒ¯å‡ºæŒ‰éˆ• -->
        <button class="btn glass-2 px-4 py-2 rounded-xl" :disabled="drawLog.length===0" @click="exportXLSX">åŒ¯å‡º XLSX</button>
      </div>

      <p class="mt-3 text-sm text-gray-400">{{ t('stats_total') }} <b class="mono">{{ participants.length }}</b> Â· {{ t('stats_eligible') }} <b class="mono">{{ eligibleCount }}</b></p>
    </section>

    <!-- Right: Visual + Results -->
    <section class="glass rounded-2xl p-5 md:p-6">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">{{ t('visual_title') }}</h3>
        <div class="flex items-center gap-2 text-xs text-gray-400">
          <span class="inline-block h-3 w-3 rounded-full bg-amber-500"></span>
          <span>{{ t('legend_pointer') }}</span>
        </div>
      </div>
      <div class="rounded-2xl glass-2 p-4 min-h-[320px] md:min-h-[380px] flex items-center justify-center relative overflow-hidden">
        <!-- fixed pointer for wheel mode -->
        <div v-if="mode==='wheel'" class="absolute top-2 left-1/2 -translate-x-1/2 z-10">
          <div class="pointer"></div>
        </div>
        <!-- Components -->
        <wheel-canvas v-if="mode==='wheel'" ref="visualRef" :items="participants" class="w-full"></wheel-canvas>
        <photo-wall v-else-if="mode==='wall'" ref="visualRef" :items="participants" class="w-full"></photo-wall>
        <grid-nine v-else ref="visualRef" :items="participants" class="w-full"></grid-nine>
      </div>

      <!-- Winners -->
      <div class="mt-5">
        <div class="flex items-center justify-between gap-2 mb-2">
          <h4 class="font-semibold">{{ t('winners_latest') }}</h4>
          <button class="btn text-xs px-2 py-1 rounded-md glass-2" @click="winners=[]">{{ t('btn_clear_winners') }}</button>
        </div>
        <div class="flex flex-wrap gap-2 max-h-28 overflow-auto scrollbar-thin">
          <span v-for="(w,i) in winners" :key="'w-'+i" class="px-2 py-1 rounded-full bg-amber-500 text-black text-xs">{{ w.name }} Â· {{ t('label_round') }} {{ w.round }}</span>
          <span v-if="winners.length===0" class="text-xs text-gray-400">{{ t('no_winners_yet') }}</span>
        </div>
      </div>

      <!-- Log -->
      <div class="mt-6">
        <h4 class="font-semibold mb-2">{{ t('log_title') }}</h4>
        <div class="overflow-auto max-h-48 rounded-xl glass-2">
          <table class="w-full text-sm">
            <thead class="text-gray-300">
            <tr>
              <th class="text-left px-3 py-2">{{ t('th_time') }}</th>
              <th class="text-left px-3 py-2">{{ t('th_round') }}</th>
              <th class="text-left px-3 py-2">{{ t('th_method') }}</th>
              <th class="text-left px-3 py-2">{{ t('th_winners') }}</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="(row, idx) in drawLog" :key="'log-'+idx" class="border-t border-white/10">
              <td class="px-3 py-2 whitespace-nowrap">{{ row.time }}</td>
              <td class="px-3 py-2">{{ row.round }}</td>
              <td class="px-3 py-2">{{ row.method }}</td>
              <td class="px-3 py-2">{{ row.winners.join(', ') }}</td>
            </tr>
            <tr v-if="drawLog.length===0">
              <td class="px-3 py-3 text-center text-gray-500" colspan="4">{{ t('log_empty') }}</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- åŸºæœ¬è³‡è¨Šå¡«å¯«å€ -->
  <div class="mb-4 space-y-2">
    <div>
      <label class="block text-sm text-gray-300 mb-1">æŠ½çç›®çš„/ä¸»é¡Œ</label>
      <input v-model="lotteryPurpose" class="glass-2 w-full rounded-lg p-2 text-sm" placeholder="è«‹è¼¸å…¥æœ¬æ¬¡æŠ½çä¸»é¡Œæˆ–ç›®çš„" />
    </div>
    <div>
      <label class="block text-sm text-gray-300 mb-1">æŠ½çé¸é …/èªªæ˜ï¼ˆå¯é¸ï¼‰</label>
      <textarea v-model="lotteryOptions" class="glass-2 w-full rounded-lg p-2 text-sm" rows="2" placeholder="ä¾‹å¦‚ï¼šçå“å…§å®¹ã€æ´»å‹•èªªæ˜ç­‰"></textarea>
    </div>
  </div>
</div>

<script>
const { createApp, defineComponent } = Vue;

/* ===================== i18n ===================== */
const i18nData = {
  'zh-TW': {
    title: 'æŠ½çå¼•æ“ï¼ˆæ¥µç°¡ Ã— ç§‘æŠ€æ„Ÿï¼‰',
    subtitle: 'Canvas è½‰ç›¤ / 3D ç…§ç‰‡ç‰† / ä¹å®®æ ¼ Â· æ¬Šé‡èˆ‡å¯é©—è­‰éš¨æ©Ÿ Â· å››èªç³»',
    btn_sample: 'è¼‰å…¥ç¯„ä¾‹',
    tab_wheel: 'è½‰ç›¤', tab_wall: '3D ç…§ç‰‡ç‰†', tab_grid: 'ä¹å®®æ ¼',
    roster_label: 'åƒè³½è€…åå–®ï¼ˆæ¯è¡Œä¸€ä½ï¼›å¯ç”¨é€—è™Ÿ/Tab/è±ç·šåˆ†éš”æ¬Šé‡ï¼Œå¦‚ ç‹å°æ˜,3ï¼‰',
    roster_ph: 'ä¾‹ï¼š\nç‹å°æ˜,3\næå°è¯,1\né™³å¤§åŒ,2',
    btn_parse: 'è§£æåå–®', btn_clear: 'æ¸…ç©ºåå–®',
    draw_count: 'æœ¬æ¬¡æŠ½å‡ºäººæ•¸', no_repeat: 'æŠ½å‡ºå¾Œæ’é™¤å¾—çè€…ï¼ˆé¿å…é‡è¤‡ï¼‰',
    rng_title: 'éš¨æ©Ÿæ¨¡å¼', rng_crypto: 'Cryptoï¼ˆå¯†ç¢¼å­¸ç­‰ç´šï¼Œå»ºè­°ï¼‰', rng_seeded: 'Seededï¼ˆå¯é©—è­‰ï¼Œç”¨ Salt + Public Seedï¼‰', rng_math: 'Math.randomï¼ˆä¸å»ºè­°ï¼‰',
    seed_salt: 'Saltï¼ˆé å…ˆå…¬é–‹/ä¿ç•™ï¼‰', btn_gen_salt: 'ç”¢ç”Ÿ Salt', seed_public: 'Public Seedï¼ˆå…¬é–‹ä¾†æºï¼Œå¦‚æ—¥æœŸç¢¼/æœƒè­°ä»£ç¢¼ï¼‰', seed_public_ph: 'ä¾‹å¦‚ï¼š2025-08-28-UAT-Session-A', seed_tip: 'é©—è­‰æ–¹å¼ï¼šç›¸åŒåå–®èˆ‡æ¬Šé‡ã€åŒä¸€ Salt èˆ‡ Public Seedã€åŒåºåˆ—æŠ½å– â‡’ çµæœå¯é‡ç¾ã€‚',
    btn_draw: 'é–‹å§‹æŠ½ç', btn_drawing: 'æŠ½çä¸­â€¦', btn_reset_eligibility: 'æ¢å¾©è³‡æ ¼', btn_export: 'åŒ¯å‡ºç´€éŒ„ (JSON)',
    stats_total: 'åå–®ç­†æ•¸ï¼š', stats_eligible: 'å¯æŠ½äººæ•¸ï¼š',
    visual_title: 'è¦–è¦ºå€', legend_pointer: 'æŒ‡é‡/ç„¦é»',
    winners_latest: 'æœ€æ–°å¾—çè€…', btn_clear_winners: 'æ¸…ç©º', label_round: 'è¼ªæ¬¡', no_winners_yet: 'å°šç„¡è³‡æ–™',
    log_title: 'æŠ½çç´€éŒ„', th_time: 'æ™‚é–“', th_round: 'è¼ªæ¬¡', th_method: 'æ¨¡å¼', th_winners: 'å¾—çè€…', log_empty: 'å°šç„¡æŠ½çç´€éŒ„'
  },
  'zh-CN': {
    title: 'æŠ½å¥–å¼•æ“ï¼ˆæç®€ Ã— ç§‘æŠ€æ„Ÿï¼‰',
    subtitle: 'Canvas è½¬ç›˜ / 3D ç…§ç‰‡å¢™ / ä¹å®«æ ¼ Â· æƒé‡ä¸å¯éªŒè¯éšæœº Â· å››è¯­è¨€',
    btn_sample: 'è½½å…¥ç¤ºä¾‹',
    tab_wheel: 'è½¬ç›˜', tab_wall: '3D ç…§ç‰‡å¢™', tab_grid: 'ä¹å®«æ ¼',
    roster_label: 'å‚èµ›è€…åå•ï¼ˆæ¯è¡Œä¸€ä½ï¼›å¯ç”¨é€—å·/Tab/ç«–çº¿åˆ†éš”æƒé‡ï¼Œå¦‚ å¼ ä¸‰,3ï¼‰',
    roster_ph: 'ç¤ºä¾‹ï¼š\nå¼ ä¸‰,3\næå››,1\nç‹äº”,2',
    btn_parse: 'è§£æåå•', btn_clear: 'æ¸…ç©ºåå•',
    draw_count: 'æœ¬æ¬¡æŠ½å–äººæ•°', no_repeat: 'æŠ½ä¸­åæ’é™¤ï¼ˆé¿å…é‡å¤ï¼‰',
    rng_title: 'éšæœºæ¨¡å¼', rng_crypto: 'Cryptoï¼ˆåŠ å¯†çº§ï¼Œæ¨èï¼‰', rng_seeded: 'Seededï¼ˆå¯éªŒè¯ï¼ŒSalt + Public Seedï¼‰', rng_math: 'Math.randomï¼ˆä¸æ¨èï¼‰',
    seed_salt: 'Saltï¼ˆé¢„å…ˆå…¬å¼€/ä¿ç•™ï¼‰', btn_gen_salt: 'ç”Ÿæˆ Salt', seed_public: 'Public Seedï¼ˆå…¬å¼€æ¥æºï¼Œå¦‚æ—¥æœŸç /ä¼šè®®ä»£ç ï¼‰', seed_public_ph: 'ä¾‹å¦‚ï¼š2025-08-28-UAT-Session-A', seed_tip: 'éªŒè¯ï¼šç›¸åŒåå•ä¸æƒé‡ã€åŒä¸€ Salt/Seedã€åŒåºåˆ—æŠ½å– â‡’ ç»“æœå¯å¤ç°ã€‚',
    btn_draw: 'å¼€å§‹æŠ½å¥–', btn_drawing: 'æŠ½å¥–ä¸­â€¦', btn_reset_eligibility: 'æ¢å¤èµ„æ ¼', btn_export: 'å¯¼å‡ºè®°å½• (JSON)',
    stats_total: 'åå•æ¡æ•°ï¼š', stats_eligible: 'å¯æŠ½äººæ•°ï¼š',
    visual_title: 'å¯è§†åŒ–åŒº', legend_pointer: 'æŒ‡é’ˆ/ç„¦ç‚¹',
    winners_latest: 'æœ€æ–°ä¸­å¥–è€…', btn_clear_winners: 'æ¸…ç©º', label_round: 'è½®æ¬¡', no_winners_yet: 'æš‚æ— æ•°æ®',
    log_title: 'æŠ½å¥–è®°å½•', th_time: 'æ—¶é—´', th_round: 'è½®æ¬¡', th_method: 'æ¨¡å¼', th_winners: 'ä¸­å¥–è€…', log_empty: 'æš‚æ— è®°å½•'
  },
  'en': {
    title: 'Lottery Engine (Minimal Ã— Futuristic)',
    subtitle: 'Canvas Wheel / 3D Photo Wall / 3Ã—3 Grid Â· Weighted & Verifiable RNG Â· 4 Languages',
    btn_sample: 'Load Sample',
    tab_wheel: 'Wheel', tab_wall: '3D Wall', tab_grid: '3Ã—3 Grid',
    roster_label: 'Participants (one per line; optional weight via comma/Tab/pipe, e.g., Alex,3)',
    roster_ph: 'e.g.\nAlex,3\nBella,1\nChen,2',
    btn_parse: 'Parse Roster', btn_clear: 'Clear Roster',
    draw_count: 'Winners to draw', no_repeat: 'Exclude winners from future draws',
    rng_title: 'Randomness Mode', rng_crypto: 'Crypto (CSPRNG, recommended)', rng_seeded: 'Seeded (verifiable: Salt + Public Seed)', rng_math: 'Math.random (not recommended)',
    seed_salt: 'Salt (pre-commit/retain)', btn_gen_salt: 'Generate Salt', seed_public: 'Public Seed (public source, e.g., date/session code)', seed_public_ph: 'e.g., 2025-08-28-UAT-Session-A', seed_tip: 'Verification: same roster & weights, same Salt & Public Seed, same sequence â‡’ identical results.',
    btn_draw: 'Draw', btn_drawing: 'Drawingâ€¦', btn_reset_eligibility: 'Reset Eligibility', btn_export: 'Export Log (JSON)',
    stats_total: 'Total entries:', stats_eligible: 'Eligible:',
    visual_title: 'Visual Stage', legend_pointer: 'Pointer/Focus',
    winners_latest: 'Latest Winners', btn_clear_winners: 'Clear', label_round: 'round', no_winners_yet: 'No winners yet',
    log_title: 'Draw Log', th_time: 'Time', th_round: 'Round', th_method: 'Method', th_winners: 'Winners', log_empty: 'No records yet'
  },
  'ja': {
    title: 'æŠ½é¸ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆãƒŸãƒ‹ãƒãƒ« Ã— è¿‘æœªæ¥ï¼‰',
    subtitle: 'Canvas ãƒ›ã‚¤ãƒ¼ãƒ« / 3D ãƒ•ã‚©ãƒˆã‚¦ã‚©ãƒ¼ãƒ« / 3Ã—3 ã‚°ãƒªãƒƒãƒ‰ Â· é‡ã¿ä»˜ã & æ¤œè¨¼å¯èƒ½ RNG Â· 4 è¨€èª',
    btn_sample: 'ã‚µãƒ³ãƒ—ãƒ«èª­è¾¼',
    tab_wheel: 'ãƒ›ã‚¤ãƒ¼ãƒ«', tab_wall: '3D ã‚¦ã‚©ãƒ¼ãƒ«', tab_grid: '3Ã—3 ã‚°ãƒªãƒƒãƒ‰',
    roster_label: 'å‚åŠ è€…ï¼ˆ1 è¡Œã« 1 åï¼›ã‚«ãƒ³ãƒ/Tab/ç¸¦æ£’ã§é‡ã¿ï¼šä¾‹ Taro,3ï¼‰',
    roster_ph: 'ä¾‹ï¼š\nSato,3\nSuzuki,1\nTanaka,2',
    btn_parse: 'åç°¿è§£æ', btn_clear: 'åç°¿ã‚¯ãƒªã‚¢',
    draw_count: 'å½“é¸äººæ•°', no_repeat: 'å½“é¸è€…ã‚’æ¬¡å›ä»¥é™ã‹ã‚‰é™¤å¤–',
    rng_title: 'ãƒ©ãƒ³ãƒ€ãƒ ãƒ¢ãƒ¼ãƒ‰', rng_crypto: 'Cryptoï¼ˆæ¨å¥¨ï¼‰', rng_seeded: 'Seededï¼ˆSalt + Public Seed ã§æ¤œè¨¼ï¼‰', rng_math: 'Math.randomï¼ˆéæ¨å¥¨ï¼‰',
    seed_salt: 'Saltï¼ˆäº‹å‰å…¬é–‹/ä¿æŒï¼‰', btn_gen_salt: 'Salt ç”Ÿæˆ', seed_public: 'Public Seedï¼ˆå…¬é–‹æƒ…å ±ï¼šæ—¥ä»˜/ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰', seed_public_ph: 'ä¾‹ï¼š2025-08-28-UAT-Session-A', seed_tip: 'æ¤œè¨¼ï¼šåŒã˜åç°¿ãƒ»é‡ã¿ã€åŒã˜ Salt/Seedã€åŒé †æŠ½å‡º â‡’ çµæœãŒå†ç¾ã€‚',
    btn_draw: 'æŠ½é¸', btn_drawing: 'æŠ½é¸ä¸­â€¦', btn_reset_eligibility: 'è³‡æ ¼ã‚’ãƒªã‚»ãƒƒãƒˆ', btn_export: 'ãƒ­ã‚°å‡ºåŠ› (JSON)',
    stats_total: 'åç°¿æ•°ï¼š', stats_eligible: 'æŠ½é¸å¯èƒ½ï¼š',
    visual_title: 'ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«', legend_pointer: 'ãƒã‚¤ãƒ³ã‚¿/ãƒ•ã‚©ãƒ¼ã‚«ã‚¹',
    winners_latest: 'ç›´è¿‘ã®å½“é¸è€…', btn_clear_winners: 'ã‚¯ãƒªã‚¢', label_round: 'å›', no_winners_yet: 'ãƒ‡ãƒ¼ã‚¿ãªã—',
    log_title: 'æŠ½é¸ãƒ­ã‚°', th_time: 'æ™‚åˆ»', th_round: 'å›', th_method: 'æ–¹å¼', th_winners: 'å½“é¸è€…', log_empty: 'ãƒ­ã‚°ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“'
  }
};

/* ===================== Components ===================== */
const WheelCanvas = defineComponent({
  name: 'WheelCanvas',
  props: { items: { type: Array, required: true } },
  template: `
    <div class="w-full flex items-center justify-center select-none">
      <canvas ref="canvas" :width="size" :height="size" class="max-w-full"></canvas>
    </div>
  `,
  data(){ return { size: 340, rotation: 0, animId: null, spinning: false }; },
  watch:{ items(){ this.draw(); }},
  mounted(){ this.draw(); },
  beforeUnmount(){ if(this.animId) cancelAnimationFrame(this.animId); },
  methods:{
    draw(){
      const cvs = this.$refs.canvas; if(!cvs) return; const ctx = cvs.getContext('2d');
      const N = Math.max(1, this.items.length);
      ctx.clearRect(0,0,cvs.width,cvs.height);
      const R = this.size/2 - 6; const cx = this.size/2; const cy = this.size/2;
      const aPer = Math.PI * 2 / N;
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(this.rotation);
      for(let i=0;i<N;i++){
        const start = i*aPer; const end = start + aPer;
        ctx.beginPath();
        const hue = (i*360/N)|0; ctx.fillStyle = `hsl(${hue} 70% 50% / 0.9)`;
        ctx.moveTo(0,0); ctx.arc(0,0,R,start,end); ctx.closePath(); ctx.fill();
        // label
        ctx.save();
        ctx.rotate(start + aPer/2);
        ctx.textAlign = 'right'; ctx.fillStyle = '#0b0f1a'; ctx.font = '600 14px Inter, Noto Sans TC';
        const name = (this.items[i]?.name ?? `#${i+1}`);
        ctx.fillText(name, R-10, 6);
        ctx.restore();
      }
      // center
      ctx.beginPath(); ctx.arc(0,0,40,0,Math.PI*2); ctx.fillStyle = '#111827'; ctx.fill();
      ctx.restore();
      // ring
      ctx.beginPath(); ctx.arc(cx,cy,R+3,0,Math.PI*2); ctx.strokeStyle = 'rgba(255,255,255,.25)'; ctx.lineWidth=6; ctx.stroke();
    },
    spinTo(index){
      // return a Promise that resolves after animation finishes
      if(this.spinning) return Promise.resolve();
      this.spinning = true;
      const N = Math.max(1, this.items.length);
      const aPer = Math.PI*2/N;
      // We want the chosen slice center to align to top (pointer at -90deg)
      const targetAngle = -Math.PI/2 - (index + 0.5)*aPer; // wheel rotation absolute
      const current = this.rotation % (Math.PI*2);
      let delta = targetAngle - current;
      // add extra spins (>= 4 turns)
      const extra = Math.PI*2 * 6; // 6 spins for drama
      const final = current + delta + extra;
      const duration = 2600; // ms
      const startTs = performance.now();
      return new Promise(res=>{
        const easeOutCubic = (t)=>1-Math.pow(1-t,3);
        const step = (ts)=>{
          const p = Math.min(1, (ts-startTs)/duration);
          this.rotation = current + (final-current) * easeOutCubic(p);
          this.draw();
          if(p<1){ this.animId = requestAnimationFrame(step); } else { this.spinning=false; res(); }
        };
        this.animId = requestAnimationFrame(step);
      });
    }
  }
});

const PhotoWall = defineComponent({
  name: 'PhotoWall',
  props: { items: { type: Array, required: true } },
  template: `
    <div class="w-full">
      <div ref="wrap" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 wall-rotate p-2">
        <div v-for="(p,i) in items" :key="p.id||i" :data-idx="i" class="glass-2 rounded-xl p-3 text-center select-none">
          <div class="mx-auto h-12 w-12 rounded-xl flex items-center justify-center mb-2"
               :style="avatarStyle(i)">
            <span class="font-bold">{{ initials(p.name) }}</span>
          </div>
          <div class="text-xs truncate">{{ p.name }}</div>
        </div>
      </div>
    </div>
  `,
  methods:{
    initials(name){ return (name||'').split(/\s+/).map(s=>s[0]).join('').slice(0,2).toUpperCase(); },
    avatarStyle(i){ const hue=(i*47)%360; return `background: radial-gradient(circle at 30% 30%, hsl(${hue} 80% 60%), hsl(${(hue+40)%360} 80% 45%)); color:#0b0f1a;`; },
    spotlight(index){
      const wrap = this.$refs.wrap; if(!wrap) return Promise.resolve();
      const el = wrap.querySelector(`[data-idx="${index}"]`);
      if(!el) return Promise.resolve();
      // pause rotation temporarily
      wrap.style.animationPlayState = 'paused';
      el.classList.add('card-spotlight');
      return new Promise(res=>{
        setTimeout(()=>{ el.classList.remove('card-spotlight'); wrap.style.animationPlayState='running'; res(); }, 1100);
      });
    }
  }
});

const GridNine = defineComponent({
  name: 'GridNine',
  props: { items: { type: Array, required: true } },
  template: `
    <div class="w-full">
      <div class="grid grid-cols-3 gap-3 p-2" ref="grid">
        <div v-for="(c, idx) in gridItems" :key="c.key" :data-pos="idx"
             class="glass-2 rounded-xl p-4 text-center select-none">
          <div class="text-sm font-semibold truncate">{{ c.name }}</div>
          <div class="text-[10px] text-gray-400">{{ c.weight }}</div>
        </div>
      </div>
    </div>
  `,
  data(){ return { gridItems: [], sliceStart: 0 } },
  watch:{ items(){ this.rebuild(0); } },
  mounted(){ this.rebuild(0); },
  methods:{
    rebuild(targetIndex){
      const N = this.items.length;
      if(N<=9){ this.sliceStart = 0; this.gridItems = this.items.map((p,i)=>({ key:p.id||i, name:p.name, weight:p.weight, _idx:i })).slice(0,9); return; }
      // Center a window of 9 around targetIndex
      const start = Math.max(0, Math.min(targetIndex-4, N-9));
      this.sliceStart = start;
      this.gridItems = this.items.slice(start, start+9).map((p,i)=>({ key:p.id||i, name:p.name, weight:p.weight, _idx:start+i }));
    },
    animateToGlobalIndex(globalIndex){
      // ensure winner in grid
      this.rebuild(globalIndex);
      const pos = this.gridItems.findIndex(x=>x._idx===globalIndex);
      const cells = this.$refs.grid.querySelectorAll('[data-pos]');
      if(pos<0 || !cells.length) return Promise.resolve();
      // roulette style highlight
      const totalSteps = 24 + pos + Math.floor(Math.random()*6); // random extra
      let step = 0; let last=-1;
      return new Promise(res=>{
        const tick = ()=>{
          const idx = step % this.gridItems.length;
          const el = cells[idx];
          if(last>=0) cells[last]?.classList.remove('cell-highlight');
          el.classList.add('cell-highlight');
          last = idx; step++;
          if(step<=totalSteps){ setTimeout(tick, Math.min(60+step*12, 220)); }
          else{ res(); }
        };
        tick();
      });
    }
  }
});

/* ===================== Core Logic (RNG, weighting, draw) ===================== */
const Core = {
  randomCrypto(){ const b=new Uint32Array(1); crypto.getRandomValues(b); return (b[0]>>>0)/4294967296; },
  mulberry32(seed){ return function(){ let t=seed+=0x6D2B79F5; t=Math.imul(t^t>>>15, t|1); t^= t + Math.imul(t^t>>>7, t|61); return ((t^t>>>14)>>>0)/4294967296; } },
  async seededRng(seedStr){ const enc=new TextEncoder(); const buf=enc.encode(seedStr); const dig=await crypto.subtle.digest('SHA-256', buf); const v=new DataView(dig); const s=v.getUint32(0,false)||0x12345678; return Core.mulberry32(s); },
  weightedPick(pool, rng){
    const eligible = pool.filter(p=>p.eligible && p.weight>0);
    const total = eligible.reduce((s,p)=>s+p.weight,0);
    if(total<=0 || eligible.length===0) return null;
    let r = rng()*total; for(const p of eligible){ if((r -= p.weight) < 0) return p; }
    return eligible[eligible.length-1];
  }
};

/* ===================== App ===================== */
createApp({
  components:{ WheelCanvas, PhotoWall, GridNine },
  data(){
    return {
      i18nData,
      currentLanguage: localStorage.getItem('lottery.lang') || 'zh-TW',
      mode: localStorage.getItem('lottery.mode') || 'wheel',
      participantsText: localStorage.getItem('lottery.text') || '',
      participants: [],
      drawCount: 1,
      noRepeat: true,
      rngMethod: localStorage.getItem('lottery.rng') || 'crypto',
      seedSalt: localStorage.getItem('lottery.salt') || '',
      publicSeed: localStorage.getItem('lottery.pubseed') || '',
      isDrawing:false,
      winners: [],
      drawLog: [],
      round: 0,

      /* Roster Table - æ–°å¢çš„è³‡æ–™çµæ§‹ */
      rosterTable: [
        { uid: Date.now() + '-0', name: '', weight: 1, nameError: false, weightError: false }
      ],
      rosterError: '',

      /* åŸºæœ¬è³‡è¨Š */
      lotteryPurpose: '',
      lotteryOptions: ''
    };
  },
  computed:{
    eligibleCount(){ return this.participants.filter(p=>p.eligible && p.weight>0).length; }
  },
  watch:{
    currentLanguage(v){ localStorage.setItem('lottery.lang', v); },
    mode(v){ localStorage.setItem('lottery.mode', v); },
    participantsText(v){ localStorage.setItem('lottery.text', v); },
    rngMethod(v){ localStorage.setItem('lottery.rng', v); },
    seedSalt(v){ localStorage.setItem('lottery.salt', v); },
    publicSeed(v){ localStorage.setItem('lottery.pubseed', v); }
  },
  methods:{
    t(key){ return this.i18nData[this.currentLanguage]?.[key] || key; },
    addRow() {
      this.rosterTable.push({ uid: Date.now() + '-' + Math.random().toString(36).slice(2,6), name: '', weight: 1, nameError: false, weightError: false });
    },
    removeRow(idx) {
      this.rosterTable.splice(idx, 1);
    },
    validateName(idx) {
      const p = this.rosterTable[idx];
      p.nameError = !p.name.trim();
      this.updateRosterError();
    },
    validateWeight(idx) {
      const p = this.rosterTable[idx];
      p.weightError = !(Number.isInteger(p.weight) && p.weight > 0);
      this.updateRosterError();
    },
    updateRosterError() {
      this.rosterError = '';
      for (const p of this.rosterTable) {
        if (p.nameError) { this.rosterError = 'å§“åä¸å¯ç©ºç™½'; break; }
        if (p.weightError) { this.rosterError = 'æ¬Šé‡å¿…é ˆç‚ºæ­£æ•´æ•¸'; break; }
      }
    },
    clearRoster() {
      this.rosterTable = [{ uid: Date.now() + '-0', name: '', weight: 1, nameError: false, weightError: false }];
      this.rosterError = '';
    },
    batchPaste() {
      const text = prompt('è«‹è²¼ä¸Šåå–®ï¼Œæ¯è¡Œæ ¼å¼ï¼šå§“å,æ¬Šé‡ï¼ˆæ¬Šé‡å¯çœç•¥ï¼‰');
      if (!text) return;
      const lines = text.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
      this.rosterTable = lines.map((line, idx) => {
        const [name, weight] = line.split(/[\t,\|]+/).map(s=>s.trim());
        return {
          uid: Date.now() + '-' + idx,
          name: name || '',
          weight: Number(weight) > 0 ? Number(weight) : 1,
          nameError: !name,
          weightError: !(Number.isInteger(Number(weight)) && Number(weight) > 0)
        };
      });
      this.updateRosterError();
    },
    // è¦†å¯«åŸæœ¬çš„ loadSample
    loadSample() {
      const sample = [
        { name: 'ç‹å°æ˜', weight: 3 },
        { name: 'æå°è¯', weight: 1 },
        { name: 'é™³å¤§åŒ', weight: 2 }
      ];
      this.rosterTable = sample.map((p, idx) => ({
        uid: Date.now() + '-' + idx,
        name: p.name,
        weight: p.weight,
        nameError: false,
        weightError: false
      }));
      this.rosterError = '';
    },
    // è§£æ rosterTable ç‚º participants
    parseParticipants() {
      if (this.rosterError) return;
      this.participants = this.rosterTable
        .filter(p => p.name && Number.isInteger(p.weight) && p.weight > 0)
        .map((p, idx) => ({
          id: `${Date.now()}_${idx}_${Math.random().toString(36).slice(2,7)}`,
          name: p.name,
          weight: p.weight,
          eligible: true
        }));
      this.winners = [];
      this.round = 0;
    },
    clearAll(){ this.participantsText=''; this.participants=[]; this.winners=[]; this.drawLog=[]; this.round=0; },
    resetEligibility(){ this.participants = this.participants.map(p=>({ ...p, eligible:true })); },
    generateSalt(){ const b=new Uint8Array(16); crypto.getRandomValues(b); this.seedSalt = Array.from(b).map(x=>x.toString(16).padStart(2,'0')).join(''); },

    async drawWinners(){
      if(this.participants.length===0 || this.drawCount<1) return;
      this.isDrawing = true;
      try{
        let rng = null; let methodLabel='';
        if(this.rngMethod==='crypto'){ rng = Core.randomCrypto; methodLabel='crypto'; }
        else if(this.rngMethod==='math'){ rng = Math.random; methodLabel='math'; }
        else{ const seedStr = `${this.seedSalt}|${this.publicSeed}|round:${this.round+1}`; rng = await Core.seededRng(seedStr); methodLabel = `seeded(${this.seedSalt.slice(0,6)}â€¦|${this.publicSeed})`; }

        const winnersThisRound=[]; const N = Math.max(1, Math.floor(this.drawCount));
        for(let i=0;i<N;i++){
          const pick = Core.weightedPick(this.participants, rng);
          if(!pick) break;
          winnersThisRound.push(pick);
          if(this.noRepeat){ const idx = this.participants.findIndex(p=>p.id===pick.id); if(idx>=0) this.participants[idx].eligible=false; }
          // Visuals (sequential per winner)
          const globalIndex = this.participants.findIndex(p=>p.id===pick.id);
          if(this.mode==='wheel'){ await this.$refs.visualRef.spinTo(globalIndex); }
          else if(this.mode==='wall'){ await this.$refs.visualRef.spotlight(globalIndex); }
          else { await this.$refs.visualRef.animateToGlobalIndex(globalIndex); }

          // record winner for display
          this.round += 1;
          this.winners.push({ name: pick.name, weight: pick.weight, round: this.round });
        }

        if(winnersThisRound.length>0){
          const ts = new Date();
          this.drawLog.unshift({ time: ts.toLocaleString(), round: this.round, method: methodLabel, winners: winnersThisRound.map(w=>w.name) });
        }
      } finally { this.isDrawing=false; }
    },

    exportLog(){
      const payload = { lang:this.currentLanguage, mode:this.mode, rngMethod:this.rngMethod, seedSalt:this.seedSalt, publicSeed:this.publicSeed, noRepeat:this.noRepeat,
                        roster:this.participants.map(p=>({name:p.name, weight:p.weight})), log:this.drawLog };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`lottery_log_${Date.now()}.json`; a.click(); URL.revokeObjectURL(url);
    },
    exportXLSX() {
      // å½™æ•´è³‡æ–™
      const now = new Date();
      const sheetData = [
        ['æŠ½çä¸»é¡Œ', this.lotteryPurpose],
        ['æŠ½çèªªæ˜', this.lotteryOptions],
        ['æŠ½çæ™‚é–“', now.toLocaleString()],
        [],
        ['è¼ªæ¬¡', 'æ™‚é–“', 'å¾—çè€…', 'æŠ½çæ–¹å¼']
      ];
      // æ¯ç­†ç´€éŒ„
      this.drawLog.slice().reverse().forEach(row => {
        sheetData.push([
          row.round,
          row.time,
          row.winners.join(', '),
          row.method
        ]);
      });
      // ç”¢ç”Ÿ XLSX
      const ws = XLSX.utils.aoa_to_sheet(sheetData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'æŠ½çç´€éŒ„');
      XLSX.writeFile(wb, `lottery_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours()}${now.getMinutes()}${now.getSeconds()}.xlsx`);
    }
  },
  mounted(){ if(!this.seedSalt) this.generateSalt(); if((this.participantsText||'').trim()) this.parseParticipants(); }
}).mount('#app');
</script>
</body>
</html>
