<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <title>çµ‚æ¥µå¯†ç¢¼æ•™å­¸ç‰ˆï½œäºŒåˆ†æœå°‹æ¨ç†è¨“ç·´ï½œæ•¸ä½é‡‘åº«å…¥ä¾µæ¨¡æ“¬ï¼ˆä¸å«é‚Šç•Œï¼‰</title>
  <meta name="description" content="æ•™å­¸å°å‘çš„çµ‚æ¥µå¯†ç¢¼ï¼ˆä¸å«é‚Šç•Œï¼‰æ¨ç†è¨“ç·´ï¼šå€™é¸æ•¸ã€ç†è«–æœ€å°‘æ­¥æ•¸ã€äºŒåˆ†æœå°‹ç­–ç•¥æç¤ºã€çµç®— Summaryã€è¿·ä½ å•å·æ”¶é›†æ•™å­¸å·¥å…·éœ€æ±‚ã€‚æ”¯æ´ä¸­è‹±æ—¥èˆ‡æ¯æ—¥æŒ‘æˆ°ã€‚">

  <meta name="robots" content="index,follow,max-image-preview:large" />

  <meta property="og:type" content="website">
  <meta property="og:title" content="çµ‚æ¥µå¯†ç¢¼æ•™å­¸ç‰ˆï½œäºŒåˆ†æœå°‹æ¨ç†è¨“ç·´ï¼ˆä¸å«é‚Šç•Œï¼‰">
  <meta property="og:description" content="æ•™å­¸å°å‘ï¼šå€™é¸æ•¸ã€ç†è«–æœ€å°‘æ­¥æ•¸ã€ç­–ç•¥æç¤ºã€çµç®— Summaryã€è¿·ä½ å•å·æ”¶é›†æ•™å­¸å·¥å…·éœ€æ±‚ã€‚">
  <meta property="og:image" content="https://example.com/assets/og-vault-guess.png">
  <meta property="og:locale" content="zh_TW">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="çµ‚æ¥µå¯†ç¢¼æ•™å­¸ç‰ˆï½œäºŒåˆ†æœå°‹æ¨ç†è¨“ç·´">
  <meta name="twitter:description" content="ä¸å«é‚Šç•Œè¦å‰‡çš„çµ‚æ¥µå¯†ç¢¼ï¼ŒåŠ å…¥ç­–ç•¥æ•™å­¸èˆ‡çµç®— Summaryã€‚">
  <meta name="twitter:image" content="https://example.com/assets/og-vault-guess.png">

  <!-- CSPï¼šCDN + Google Forms iframe éœ€è¦çš„æœ€å°é›†åˆ -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    base-uri 'self';
    object-src 'none';
    frame-ancestors 'none';
    img-src 'self' https: data:;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.tailwindcss.com;
    font-src 'self' https://fonts.gstatic.com data:;
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com;
    connect-src 'self';
    frame-src https://docs.google.com;
        " />

  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <style>
    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background-color: #0d1117;
    }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }
    .tab-button { transition: all 0.2s ease; }
    .focus-ring:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(45, 212, 191, 0.6); }
  </style>
</head>

<body>
<div id="app" class="min-h-screen p-4 sm:p-8 flex items-center justify-center">
  <div class="w-full max-w-5xl bg-gray-800 p-6 sm:p-10 rounded-3xl shadow-2xl border border-gray-700">

    <!-- Top bar -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <div class="flex items-center gap-2">
        <span class="text-xs font-semibold text-gray-200 bg-gray-700/70 border border-gray-600 px-3 py-1 rounded-full">
          {{ t.badge_teaching }}
        </span>
        <span class="text-xs text-gray-400">
          {{ t.badge_rule }}
        </span>
      </div>

      <div class="flex flex-wrap items-center gap-2 justify-end">
        <button @click="openSettings()"
                class="focus-ring px-3 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-gray-100 text-sm font-semibold border border-gray-600">
          {{ t.settings }}
        </button>

        <button @click="toggleCoach()"
                class="focus-ring px-3 py-2 rounded-xl text-sm font-semibold border"
                :class="coachEnabled ? 'bg-teal-600 hover:bg-teal-500 border-teal-400 text-white' : 'bg-gray-700 hover:bg-gray-600 border-gray-600 text-gray-100'">
          {{ coachEnabled ? t.coach_on : t.coach_off }}
        </button>

        <label class="inline-flex items-center gap-2 bg-gray-700/60 px-4 py-2 rounded-xl border border-gray-600">
          <input type="checkbox" v-model="dailyChallengeEnabled" class="accent-teal-400" />
          <span class="text-gray-200 text-sm font-semibold">{{ t.daily_toggle }}</span>
        </label>
      </div>
    </div>

    <header class="text-center mb-8">
      <h1 class="text-4xl sm:text-5xl font-extrabold text-teal-400 mb-2">{{ t.title }}</h1>
      <p class="text-lg text-gray-400 mb-5">
        {{ translate(t.subtitle, minRange, maxRange) }}
      </p>

      <div class="flex flex-wrap justify-center gap-2 mb-3">
        <span class="text-gray-400 mr-2 self-center">{{ t.language }}:</span>

        <button @click="changeLanguage('zh')"
                class="focus-ring px-3 py-1 text-sm font-semibold text-white rounded-full transition duration-200 shadow-lg"
                :class="language === 'zh' ? 'bg-teal-600 ring-2 ring-teal-400' : 'bg-gray-600 hover:bg-teal-700'">
          ç¹é«”ä¸­æ–‡
        </button>

        <button @click="changeLanguage('en')"
                class="focus-ring px-3 py-1 text-sm font-semibold text-white rounded-full transition duration-200 shadow-lg"
                :class="language === 'en' ? 'bg-teal-600 ring-2 ring-teal-400' : 'bg-gray-600 hover:bg-teal-700'">
          English
        </button>

        <button @click="changeLanguage('jp')"
                class="focus-ring px-3 py-1 text-sm font-semibold text-white rounded-full transition duration-200 shadow-lg"
                :class="language === 'jp' ? 'bg-teal-600 ring-2 ring-teal-400' : 'bg-gray-600 hover:bg-teal-700'">
          æ—¥æœ¬èª
        </button>
      </div>

      <div class="text-gray-400 text-sm">
        {{ t.daily_seed_label }}:
        <span class="text-gray-200 font-mono">{{ dailySeedInfo }}</span>
      </div>
    </header>

    <!-- Config -->
    <div class="bg-gray-900 p-5 rounded-2xl mb-6 border border-teal-500/30 shadow-2xl">
      <h2 class="text-2xl font-bold text-teal-300 mb-4 border-b border-gray-700 pb-2 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37h.001z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
        {{ t.header_config }}
      </h2>

      <div class="flex flex-wrap gap-2 mb-4">
        <button v-for="(mode, key) in gameModes"
                :key="key"
                @click="setGameMode(key)"
                class="focus-ring tab-button px-4 py-2 text-sm font-semibold text-white rounded-lg shadow-md flex-grow sm:flex-grow-0"
                :class="gameModeKey === key ? 'bg-teal-600 ring-2 ring-teal-400' : 'bg-gray-700 hover:bg-gray-600'">
          {{ t[mode.nameKey] }}
        </button>
      </div>

      <div class="p-4 bg-gray-700/50 rounded-xl">
        <p v-if="gameModeKey !== 'custom'" class="text-sm text-gray-200 mb-3">
          {{ translate(t.config_info, t[gameModes[gameModeKey].nameKey], gameModes[gameModeKey].min, gameModes[gameModeKey].max, gameModes[gameModeKey].attempts) }}
        </p>

        <div v-else class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="col-span-1 md:col-span-2">
            <label class="block text-gray-300 text-sm mb-1">{{ t.config_range }}</label>
            <div class="flex space-x-2">
              <input type="number" v-model.number="customMin" min="1" max="999"
                     class="focus-ring p-2 w-1/2 bg-gray-600 text-white rounded-lg"
                     inputmode="numeric" pattern="\\d*">
              <span class="self-center text-gray-200">-</span>
              <input type="number" v-model.number="customMax" :min="customMin + 1" max="10000"
                     class="focus-ring p-2 w-1/2 bg-gray-600 text-white rounded-lg"
                     inputmode="numeric" pattern="\\d*">
            </div>
          </div>
          <div>
            <label class="block text-gray-300 text-sm mb-1">{{ t.config_attempts }}</label>
            <input type="number" v-model.number="customAttempts" min="1" max="50"
                   class="focus-ring p-2 w-full bg-gray-600 text-white rounded-lg"
                   inputmode="numeric" pattern="\\d*">
          </div>
        </div>
      </div>

      <button @click="startGame"
              class="focus-ring mt-4 w-full px-6 py-3 text-white font-bold rounded-xl shadow-lg transform transition duration-200 ease-in-out"
              :class="gameStatus === 'playing' ? 'bg-red-500 hover:bg-red-600 shadow-red-500/40' : 'bg-blue-500 hover:bg-blue-600 shadow-blue-500/40'">
        {{ gameStatus === 'playing' ? t.restart_game : t.start_game }}
      </button>

      <!-- Coach panel -->
      <div v-if="coachEnabled" class="mt-4 p-4 rounded-2xl bg-gray-900/60 border border-gray-700">
        <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
          <div>
            <div class="text-gray-200 font-semibold">{{ t.coach_title }}</div>
            <div class="text-gray-400 text-sm mt-1">{{ t.coach_desc }}</div>
          </div>

          <button @click="applyRecommendedGuess()"
                  :disabled="gameStatus !== 'playing'"
                  class="focus-ring px-4 py-2 rounded-xl text-sm font-bold border"
                  :class="gameStatus === 'playing' ? 'bg-teal-600 hover:bg-teal-500 border-teal-400 text-white' : 'bg-gray-700 border-gray-600 text-gray-300 cursor-not-allowed opacity-70'">
            {{ t.coach_fill }}
          </button>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4">
          <div class="p-3 rounded-xl bg-gray-800 border border-gray-700">
            <div class="text-gray-400 text-xs">{{ t.candidates_label }}</div>
            <div class="text-white text-2xl font-extrabold font-mono">{{ candidateCount }}</div>
            <div class="text-gray-400 text-xs mt-1">{{ t.candidates_hint }}</div>
          </div>
          <div class="p-3 rounded-xl bg-gray-800 border border-gray-700">
            <div class="text-gray-400 text-xs">{{ t.optimal_label }}</div>
            <div class="text-white text-2xl font-extrabold font-mono">{{ theoreticalMinSteps }}</div>
            <div class="text-gray-400 text-xs mt-1">{{ translate(t.optimal_hint, theoreticalMinSteps) }}</div>
          </div>
          <div class="p-3 rounded-xl bg-gray-800 border border-gray-700">
            <div class="text-gray-400 text-xs">{{ t.recommend_label }}</div>
            <div class="text-white text-2xl font-extrabold font-mono">{{ recommendedGuess }}</div>
            <div class="text-gray-400 text-xs mt-1">{{ translate(t.recommend_hint, recommendedGuess) }}</div>
          </div>
        </div>

        <div class="mt-3 text-sm">
          <span class="text-gray-300 font-semibold">{{ t.coach_feedback_label }}</span>
          <span class="text-gray-200">{{ coachFeedback }}</span>
        </div>
      </div>
    </div>

    <!-- Status cards -->
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6 text-center">
      <div class="p-4 bg-gray-700 rounded-xl shadow-inner border border-gray-600">
        <p class="text-gray-300 text-sm">{{ t.current_mode }}</p>
        <p class="text-xl font-bold text-yellow-300">{{ t[gameModes[gameModeKey].nameKey] }}</p>
      </div>
      <div class="p-4 bg-gray-700 rounded-xl shadow-inner border border-gray-600">
        <p class="text-gray-300 text-sm">{{ t.attempt }}</p>
        <p class="text-2xl font-bold text-teal-300">{{ currentAttempts }} / {{ maxAttempts }}</p>
      </div>
      <div class="p-4 bg-gray-700 rounded-xl shadow-inner border border-gray-600">
        <p class="text-gray-300 text-sm">{{ t.high_score }}</p>
        <p class="text-2xl font-bold text-yellow-300">{{ highScore !== null ? translate(t.attempt) + ' ' + highScore : 'N/A' }}</p>
      </div>
    </div>

    <!-- Game -->
    <div class="bg-gray-700 p-6 rounded-2xl mb-8 shadow-xl border border-gray-600">
      <p aria-live="polite"
         :class="{
           'text-green-300': gameStatus === 'won',
           'text-red-300': gameStatus === 'lost',
           'text-blue-200': gameStatus === 'playing'
         }"
         class="text-xl font-semibold text-center mb-4 transition-colors duration-300">
        {{ gameMessage }}
      </p>

      <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
        <input ref="guessInputRef"
               type="number"
               v-model.number="guess"
               :placeholder="translate(t.input_placeholder, minRange, maxRange)"
               :disabled="gameStatus !== 'playing'"
               @keyup.enter="gameStatus === 'playing' ? makeGuess() : startGame()"
               @input="isInputInvalid = false"
               :aria-invalid="isInputInvalid ? 'true' : 'false'"
               class="focus-ring flex-grow p-3 bg-gray-600 text-white rounded-xl placeholder-gray-200/50 transition text-center"
               :class="isInputInvalid ? 'border-2 border-red-500 ring-4 ring-red-500/30' : 'border border-gray-600'"
               inputmode="numeric" pattern="\\d*">

        <button @click="gameStatus === 'playing' ? makeGuess() : startGame()"
                :disabled="gameStatus !== 'playing'"
                class="focus-ring w-full sm:w-auto px-6 py-3 text-white font-bold rounded-xl shadow-lg transform transition duration-200 ease-in-out hover:scale-[1.01]"
                :class="gameStatus === 'playing' ? 'bg-teal-500 hover:bg-teal-600 shadow-teal-500/40' : 'bg-blue-500 hover:bg-blue-600 shadow-blue-500/40 opacity-70 cursor-not-allowed'">
          {{ gameStatus === 'playing' ? t.guess_button : t.start_game }}
        </button>
      </div>

      <div v-if="coachEnabled" class="mt-4 text-center text-gray-200 text-sm">
        {{ t.tip_midpoint }}
        <span class="font-mono font-semibold text-white">{{ recommendedGuess }}</span>
      </div>
    </div>

    <!-- History -->
    <div v-if="guesses.length > 0" class="mt-8 bg-gray-800 p-4 sm:p-6 rounded-2xl border border-gray-700">
      <h3 class="text-2xl font-bold text-gray-200 mb-4 border-b border-gray-600 pb-2">
        {{ t.header_guess }} / {{ t.header_result }}
      </h3>
      <div class="max-h-64 overflow-y-auto pr-2">
        <transition-group name="list" tag="ul">
          <li v-for="(item, index) in guesses" :key="index"
              class="flex justify-between items-center p-3 mb-2 rounded-lg border border-gray-700"
              :class="index % 2 === 0 ? 'bg-gray-700/50' : 'bg-gray-700'">
            <span class="text-xl font-mono text-white w-1/4">{{ item.value }}</span>
            <span class="text-gray-100 w-3/4 text-right sm:text-left">{{ item.hint }}</span>
          </li>
        </transition-group>
      </div>
    </div>

    <!-- Teaching + CTA -->
    <section class="mt-10 bg-gray-900/50 border border-gray-700 rounded-3xl p-6">
      <h2 class="text-2xl font-extrabold text-white mb-2">{{ t.learn_title }}</h2>
      <p class="text-gray-200 leading-relaxed">
        {{ t.learn_p1 }}
      </p>

      <ul class="mt-4 space-y-2 text-gray-200">
        <li>â€¢ <span class="font-semibold text-white">{{ t.learn_b1_title }}</span> â€” {{ t.learn_b1_desc }}</li>
        <li>â€¢ <span class="font-semibold text-white">{{ t.learn_b2_title }}</span> â€” {{ t.learn_b2_desc }}</li>
        <li>â€¢ <span class="font-semibold text-white">{{ t.learn_b3_title }}</span> â€” {{ t.learn_b3_desc }}</li>
      </ul>

      <div class="mt-6 p-4 rounded-2xl bg-gray-800 border border-gray-700">
        <div class="text-white font-bold">{{ t.cta_title }}</div>
        <div class="text-gray-200 text-sm mt-1">{{ t.cta_desc }}</div>
        <div class="mt-4 flex flex-col sm:flex-row gap-2">
          <button @click="openSurvey('cta')"
                  class="focus-ring px-4 py-3 rounded-xl bg-teal-600 hover:bg-teal-500 text-white font-bold border border-teal-400">
            {{ t.cta_button }}
          </button>
        </div>
      </div>

      <div class="mt-4 text-gray-400 text-xs">
        {{ t.privacy_note }}
      </div>
    </section>

    <div class="mt-8 text-center text-gray-500 text-xs">
      {{ t.events_label }}: <span class="font-mono text-gray-300">{{ eventCount }}</span>
    </div>

  </div>

  <!-- âœ… SUMMARY modal (Win/Lose) - RESPONSIVE & ALWAYS CLOSEABLE -->
  <div v-if="summaryOpen"
       class="fixed inset-0 bg-black/60 z-50 p-4 sm:p-6"
       role="dialog" aria-modal="true" aria-label="Summary"
       @mousedown.self="closeSummary()">
    <!-- Using grid to avoid center-trap on small screens -->
    <div class="w-full h-full grid place-items-center">
      <!-- Card: max height bounded; internal scrolling -->
      <div class="w-full max-w-2xl bg-gray-900 rounded-3xl border border-gray-700 shadow-2xl overflow-hidden
                  max-h-[90vh] flex flex-col">
        <!-- Sticky header: close always visible -->
        <div class="p-5 sm:p-6 border-b border-gray-700 flex items-start justify-between gap-4 sticky top-0 bg-gray-900 z-10">
          <div>
            <div class="text-white text-2xl font-extrabold">
              {{ summaryStatusTitle }}
            </div>
            <div class="text-gray-300 text-sm mt-1">
              {{ summarySubtitle }}
            </div>
          </div>
          <button @click="closeSummary()"
                  class="focus-ring px-3 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-gray-100 text-sm font-bold border border-gray-600">
            {{ t.close }}
          </button>
        </div>

        <!-- Body scroll container -->
        <div class="p-5 sm:p-6 overflow-y-auto">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="p-4 rounded-2xl bg-gray-800 border border-gray-700">
              <div class="text-gray-400 text-xs">{{ t.summary_attempts }}</div>
              <div class="text-white text-3xl font-extrabold font-mono">{{ summary.attempts }}</div>
              <div class="text-gray-300 text-sm mt-1">{{ translate(t.summary_attempts_hint, maxAttempts) }}</div>
            </div>

            <div class="p-4 rounded-2xl bg-gray-800 border border-gray-700">
              <div class="text-gray-400 text-xs">{{ t.summary_optimal }}</div>
              <div class="text-white text-3xl font-extrabold font-mono">{{ summary.optimal }}</div>
              <div class="text-gray-300 text-sm mt-1">{{ translate(t.summary_optimal_hint, summary.optimal) }}</div>
            </div>

            <div class="p-4 rounded-2xl bg-gray-800 border border-gray-700">
              <div class="text-gray-400 text-xs">{{ t.summary_efficiency }}</div>
              <div class="text-white text-3xl font-extrabold font-mono">{{ summary.efficiency }}</div>
              <div class="text-gray-300 text-sm mt-1">{{ t.summary_efficiency_hint }}</div>
            </div>

            <div class="p-4 rounded-2xl bg-gray-800 border border-gray-700">
              <div class="text-gray-400 text-xs">{{ t.summary_time }}</div>
              <div class="text-white text-3xl font-extrabold font-mono">{{ summary.time }}</div>
              <div class="text-gray-300 text-sm mt-1">{{ t.summary_time_hint }}</div>
            </div>
          </div>

          <div class="mt-5 p-4 rounded-2xl bg-gray-800 border border-gray-700">
            <div class="text-white font-bold">{{ t.summary_takeaway_title }}</div>
            <div class="text-gray-200 mt-1">{{ summary.takeaway }}</div>
          </div>

          <div class="mt-6 flex flex-col sm:flex-row gap-2">
            <button @click="openSurvey('summary')"
                    class="focus-ring w-full px-4 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 text-gray-100 font-bold border border-gray-600">
              {{ t.survey_open }}
            </button>
          </div>

          <div class="mt-4 text-gray-400 text-xs">
            {{ t.survey_hint }}
          </div>

          <!-- Embed (optional) -->
          <div class="mt-5 rounded-2xl overflow-hidden border border-gray-700">
            <!-- Use min height but let container scroll; keep it responsive -->
            <iframe :src="googleFormEmbedUrl"
                    class="w-full h-[520px] sm:h-[560px] bg-white"
                    title="Mini Survey"
                    loading="lazy"
                    referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
        </div>

        <!-- Optional sticky footer (kept simple) -->
        <div class="border-t border-gray-700 p-4 bg-gray-900/80 sticky bottom-0">
          <button @click="closeSummary()"
                  class="focus-ring w-full px-4 py-3 rounded-xl bg-teal-600 hover:bg-teal-500 text-white font-bold border border-teal-400">
            {{ t.close }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Settings modal -->
  <div v-if="settingsOpen"
       class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50"
       role="dialog" aria-modal="true" aria-label="Settings"
       @mousedown.self="closeSettings()">
    <div class="w-full max-w-2xl bg-gray-900 rounded-3xl border border-gray-700 shadow-2xl overflow-hidden max-h-[90vh] flex flex-col">
      <div class="p-6 border-b border-gray-700 flex items-start justify-between gap-4 sticky top-0 bg-gray-900 z-10">
        <div>
          <div class="text-white text-2xl font-extrabold">{{ t.settings }}</div>
          <div class="text-gray-300 text-sm mt-1">{{ t.settings_desc }}</div>
        </div>
        <button @click="closeSettings()"
                class="focus-ring px-3 py-2 rounded-xl bg-gray-700 hover:bg-gray-600 text-gray-100 text-sm font-bold border border-gray-600">
          {{ t.close }}
        </button>
      </div>

      <div class="p-6 space-y-5 overflow-y-auto">
        <div class="p-4 rounded-2xl bg-gray-800 border border-gray-700">
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="text-white font-bold">{{ t.analytics_toggle_title }}</div>
              <div class="text-gray-300 text-sm mt-1">{{ t.analytics_toggle_desc }}</div>
            </div>
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" v-model="analyticsEnabled" class="accent-teal-400" />
              <span class="text-gray-200 text-sm font-semibold">{{ analyticsEnabled ? t.on : t.off }}</span>
            </label>
          </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          <button @click="exportMyData()"
                  class="focus-ring px-4 py-3 rounded-xl bg-teal-600 hover:bg-teal-500 text-white font-bold border border-teal-400">
            {{ t.export }}
          </button>
          <button @click="clearLocalData()"
                  class="focus-ring px-4 py-3 rounded-xl bg-red-600 hover:bg-red-500 text-white font-bold border border-red-400">
            {{ t.clear }}
          </button>
        </div>

        <div class="text-gray-400 text-xs leading-relaxed">
          {{ t.settings_note }}
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const { createApp, ref, computed, watch, nextTick, onMounted, onBeforeUnmount } = Vue;

  function hash32(str) {
    let h = 2166136261 >>> 0;
    for (let i = 0; i < str.length; i++) {
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }

  function mulberry32(seed) {
    let a = seed >>> 0;
    return function() {
      a |= 0;
      a = (a + 0x6D2B79F5) | 0;
      let t = Math.imul(a ^ (a >>> 15), 1 | a);
      t = (t + Math.imul(t ^ (t >>> 7), 61 | t)) ^ t;
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  function todayISO() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
  }

  function clampInt(v, min, max) {
    const n = Number.parseInt(v, 10);
    if (Number.isNaN(n)) return min;
    return Math.max(min, Math.min(max, n));
  }

  function msToClock(ms) {
    const s = Math.max(0, Math.floor(ms / 1000));
    const mm = String(Math.floor(s / 60)).padStart(2, '0');
    const ss = String(s % 60).padStart(2, '0');
    return `${mm}:${ss}`;
  }

  function translate(str, ...args) {
    return String(str || '').replace(/\$(\d+)/g, (_, i) => {
      const v = args[Number(i)];
      return (v === undefined || v === null) ? _ : String(v);
    });
  }

  const gameModesConfig = {
    novice_hacker: { min: 1, max: 50, attempts: 10, nameKey: 'mode_novice' },
    elite_codebreaker: { min: 1, max: 100, attempts: 10, nameKey: 'mode_elite' },
    ai_guardian: { min: 1, max: 1000, attempts: 15, nameKey: 'mode_ai_guardian' },
    custom: { min: 1, max: 100, attempts: 10, nameKey: 'mode_custom' }
  };

  const translations = {
    zh: {
      badge_teaching: "Teaching Edition",
      badge_rule: "ä¸å«é‚Šç•Œï¼ˆé–‹å€é–“ï¼‰",
      title: "ğŸ’ çµ‚æ¥µå¯†ç¢¼æ•™å­¸ç‰ˆï½œæ¨ç†è¨“ç·´",
      subtitle: "ç›®å‰ç¯„åœï¼š$0 åˆ° $1ï¼ˆä¸å«é‚Šç•Œï¼‰",
      language: "èªè¨€",
      header_config: "âš™ï¸ æ¨¡å¼èˆ‡é›£åº¦",
      mode_novice: "æ–°æ‰‹",
      mode_elite: "æ¨™æº–",
      mode_ai_guardian: "å°ˆå®¶",
      mode_custom: "è‡ªè¨‚",
      config_range: "æ•¸å­—ç¯„åœ",
      config_attempts: "æœ€å¤§å›åˆ",
      config_info: "ä½ é¸æ“‡ $0ï¼šç¯„åœ $1 åˆ° $2ï¼ˆä¸å«é‚Šç•Œï¼‰ï¼Œå…± $3 å›åˆã€‚",
      start_game: "é–‹å§‹æ–°å±€",
      restart_game: "é‡å•Ÿæœ¬å±€",
      guess_button: "é€å‡ºçŒœæ¸¬",
      input_placeholder: "è¼¸å…¥ä»‹æ–¼ $0 èˆ‡ $1 ä¹‹é–“ï¼ˆä¸å«ï¼‰çš„æ•¸å­—",
      attempt: "å›åˆ",
      current_mode: "æ¨¡å¼",
      high_score: "æœ€ä½³ç´€éŒ„ï¼ˆæœ€å°‘æ­¥æ•¸ï¼‰",
      status_playing: "æ¨ç†ä¸­ï¼šç¸®å°å€™é¸ï¼Œé€æ­¥é€¼è¿‘ç­”æ¡ˆã€‚",
      status_win: "ç ´è§£æˆåŠŸï¼ğŸ‰ ä½ å‰›å‰›å®Œæˆäº†ä¸€æ¬¡æ¼‚äº®çš„å€é–“æ”¶æ–‚ã€‚",
      status_loss: "å›åˆç”¨ç›¡ã€‚ç­”æ¡ˆæ˜¯ $0",
      hint_too_low: "å¤ªå° â†’ æ–°ç¯„åœï¼š",
      hint_too_high: "å¤ªå¤§ â†’ æ–°ç¯„åœï¼š",
      error_invalid: "è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•´æ•¸ã€‚",
      error_range: "è«‹è¼¸å…¥ä»‹æ–¼ $0 èˆ‡ $1 ä¹‹é–“ï¼ˆä¸å«é‚Šç•Œï¼‰çš„æ•¸å­—ã€‚",
      header_guess: "çŒœæ¸¬",
      header_result: "æç¤º",
      daily_toggle: "æ¯æ—¥æŒ‘æˆ°",
      daily_seed_label: "ä»Šæ—¥ç¨®å­",
      settings: "è¨­å®š",
      settings_desc: "ç®¡ç†åŒ¿ååˆ†æã€åŒ¯å‡ºèˆ‡æ¸…é™¤æœ¬æ©Ÿè³‡æ–™ã€‚",
      close: "é—œé–‰",
      on: "é–‹",
      off: "é—œ",
      analytics_toggle_title: "å…è¨±åŒ¿ååˆ†æ",
      analytics_toggle_desc: "åªè¨˜éŒ„åŒ¿åäº‹ä»¶ï¼ˆæ¨¡å¼ã€æ­¥æ•¸ã€éŒ¯èª¤ç‡ç­‰ï¼‰ï¼Œç”¨æ–¼æ”¹å–„æ•™å­¸é«”é©—ã€‚",
      export: "åŒ¯å‡ºæˆ‘çš„è³‡æ–™ï¼ˆJSONï¼‰",
      clear: "æ¸…é™¤æœ¬æ©Ÿè³‡æ–™",
      survey_open: "å¡«å¯«è¿·ä½ å•å·",
      survey_hint: "è¿·ä½ å•å·ç”¨ä¾†æ”¶é›†æ•™å­¸å·¥å…·éœ€æ±‚èˆ‡ä½¿ç”¨æƒ…å¢ƒï¼ˆå¯é¸å¡« Emailï¼‰ã€‚",
      settings_note: "å»ºè­°ï¼šæä¾›æ¸…é™¤/åŒ¯å‡ºå¯æé«˜ä¿¡ä»»èˆ‡è½‰æ›ã€‚è‹¥ä½ æœªä¾†è¦ä¸Šå¾Œç«¯ï¼Œå†æŠŠäº‹ä»¶é€åˆ° API æˆ–åˆ†æå¹³å°å³å¯ã€‚",
      events_label: "äº‹ä»¶è¨˜éŒ„æ•¸",

      coach_on: "æ•™ç·´ï¼šé–‹",
      coach_off: "æ•™ç·´ï¼šé—œ",
      coach_title: "æ¨ç†æ•™ç·´ï¼ˆæ•™å­¸æ¨¡å¼ï¼‰",
      coach_desc: "æ¨è–¦ä¸­ä½æ•¸çŒœæ¸¬ã€è§£ææ¯æ­¥åé›¢æœ€ä½³ç­–ç•¥çš„ç¨‹åº¦ï¼Œå¹«ä½ æŠŠéŠæˆ²ç©æˆã€ŒäºŒåˆ†æœå°‹ã€è¨“ç·´ã€‚",
      coach_fill: "å¥—ç”¨æ¨è–¦å€¼åˆ°è¼¸å…¥æ¡†",
      tip_midpoint: "æç¤ºï¼šæœ€ä½³ç­–ç•¥å¸¸ç”¨ã€Œä¸­ä½æ•¸ã€é€¼è¿‘ç­”æ¡ˆã€‚æ¨è–¦ï¼š",
      candidates_label: "å€™é¸æ•¸",
      candidates_hint: "å€™é¸ = ä¸Šç•Œ - ä¸‹ç•Œ - 1ã€‚",
      optimal_label: "ç†è«–æœ€å°‘æ­¥æ•¸",
      optimal_hint: "æœ€ä½³ç­–ç•¥ç´„éœ€ $0 æ­¥ã€‚",
      recommend_label: "æ¨è–¦çŒœæ¸¬",
      recommend_hint: "å»ºè­°å…ˆè©¦ $0ï¼ˆä¸­ä½æ•¸ï¼‰ã€‚",
      coach_feedback_label: "æ•™ç·´è©•èªï¼š",

      learn_title: "æŠŠã€Œçµ‚æ¥µå¯†ç¢¼ã€è®Šæˆæ•™å­¸å·¥å…·",
      learn_p1: "é€™å€‹ç‰ˆæœ¬å°ˆæ³¨æ–¼æŠŠéŠæˆ²è®Šæˆå¯ç”¨æ–¼æ•™å­¸èˆ‡è¨“ç·´çš„äº’å‹•å·¥å…·ï¼šç”¨å€™é¸æ•¸èˆ‡ç†è«–æœ€å°‘æ­¥æ•¸ï¼Œè®“å­¸ç¿’è€…ç†è§£ã€Œè³‡è¨Šé‡ã€èˆ‡ã€ŒäºŒåˆ†æœå°‹ã€çš„æ•ˆç‡å·®ç•°ã€‚",
      learn_b1_title: "å€™é¸æ•¸ï¼ˆCandidate Countï¼‰",
      learn_b1_desc: "æ¯æ¬¡çŒœæ¸¬å¾Œï¼Œå€™é¸æ•¸å¿«é€Ÿä¸‹é™ï¼›é€™æ˜¯ã€Œè³‡è¨Šè¢«å£“ç¸®ã€çš„å¯è¦–åŒ–ã€‚",
      learn_b2_title: "ç†è«–æœ€å°‘æ­¥æ•¸ï¼ˆlog2ï¼‰",
      learn_b2_desc: "æŠŠæŠ½è±¡çš„äºŒåˆ†æœå°‹æ•ˆç‡ï¼Œè®Šæˆå…·é«”å¯æ¯”è¼ƒçš„æ•¸å­—ã€‚",
      learn_b3_title: "ç­–ç•¥å›é¥‹ï¼ˆCoach Feedbackï¼‰",
      learn_b3_desc: "å‘Šè¨´å­¸ç¿’è€…é€™ä¸€æ­¥åé›¢ä¸­ä½æ•¸å¤šå°‘ï¼Œè®“è¡Œç‚ºèˆ‡ç­–ç•¥å°é½Šã€‚",

      cta_title: "ä½ æ­£åœ¨é–‹ç™¼æ•™å­¸å·¥å…·æˆ–æ•™æ¡ˆå—ï¼Ÿ",
      cta_desc: "ç•™ä¸‹ä½ çš„éœ€æ±‚ï¼Œæˆ‘å¯ä»¥æŠŠé€™å¥—éŠæˆ²æ¼”åŒ–æˆæ›´ç¬¦åˆä½ çš„æ•™å­¸æƒ…å¢ƒï¼ˆä¾‹å¦‚ï¼šèª²å ‚æ´»å‹•ã€ä½œæ¥­è©•é‡ã€å­¸ç¿’æ­·ç¨‹ç´€éŒ„ï¼‰ã€‚",
      cta_button: "ç”¨ 60 ç§’æè¿°ä½ çš„éœ€æ±‚ï¼ˆè¿·ä½ å•å·ï¼‰",
      privacy_note: "éš±ç§ï¼šæœ¬é é è¨­åªåšåŒ¿ååˆ†æï¼›è¿·ä½ å•å·ç”±ä½ è‡ªé¡˜å¡«å¯«ï¼Œå¯é¸å¡« Emailã€‚",

      summary_attempts: "æœ¬å±€æ­¥æ•¸",
      summary_attempts_hint: "ä¸Šé™ï¼š$0 å›åˆ",
      summary_optimal: "ç†è«–æœ€å°‘",
      summary_optimal_hint: "æœ€ä½³ç­–ç•¥ç´„ $0 æ­¥",
      summary_efficiency: "æ•ˆç‡",
      summary_efficiency_hint: "è¶Šæ¥è¿‘ 1.00 è¶Šæ¥è¿‘ç†è«–æœ€å„ªã€‚",
      summary_time: "è€—æ™‚",
      summary_time_hint: "å¾é–‹å§‹åˆ°çµæŸã€‚",
      summary_takeaway_title: "æ•™å­¸é‡é»ï¼ˆTakeawayï¼‰"
    },

    en: {
      badge_teaching: "Teaching Edition",
      badge_rule: "Exclusive bounds (open interval)",
      title: "ğŸ’ Teaching Editionï½œReasoning Training",
      subtitle: "Range: $0 to $1 (exclusive)",
      language: "Language",
      header_config: "âš™ï¸ Mode & Difficulty",
      mode_novice: "Novice",
      mode_elite: "Standard",
      mode_ai_guardian: "Expert",
      mode_custom: "Custom",
      config_range: "Number Range",
      config_attempts: "Max Attempts",
      config_info: "You selected $0: range $1 to $2 (exclusive), $3 attempts.",
      start_game: "Start New Game",
      restart_game: "Restart",
      guess_button: "Submit Guess",
      input_placeholder: "Enter a number strictly between $0 and $1",
      attempt: "Attempt",
      current_mode: "Mode",
      high_score: "High Score (least attempts)",
      status_playing: "Reasoning... Shrink the candidates and converge.",
      status_win: "Cracked! ğŸ‰ You performed a clean interval-convergence.",
      status_loss: "Out of attempts. The code was $0",
      hint_too_low: "Too low â†’ New range:",
      hint_too_high: "Too high â†’ New range:",
      error_invalid: "Enter a valid integer.",
      error_range: "Enter a number strictly between $0 and $1.",
      header_guess: "Guess",
      header_result: "Hint",
      daily_toggle: "Daily Challenge",
      daily_seed_label: "Daily Seed",
      settings: "Settings",
      settings_desc: "Manage analytics, export, and clear local data.",
      close: "Close",
      on: "On",
      off: "Off",
      analytics_toggle_title: "Allow anonymous analytics",
      analytics_toggle_desc: "Only anonymous events (mode, attempts, error rate) to improve teaching UX.",
      export: "Export my data (JSON)",
      clear: "Clear local data",
      survey_open: "Open mini survey",
      survey_hint: "The survey collects teaching-tool needs and scenarios (email optional).",
      settings_note: "Export/Clear improves trust. Add backend later if you want cloud analytics.",
      events_label: "Event log count",

      coach_on: "Coach: On",
      coach_off: "Coach: Off",
      coach_title: "Reasoning Coach",
      coach_desc: "Recommends midpoint guesses and explains deviation from optimal strategy.",
      coach_fill: "Fill recommended guess",
      tip_midpoint: "Tip: midpoint guesses are often optimal. Recommended:",
      candidates_label: "Candidates",
      candidates_hint: "Candidates = upper - lower - 1.",
      optimal_label: "Theoretical min steps",
      optimal_hint: "Best strategy â‰ˆ $0 steps.",
      recommend_label: "Recommended",
      recommend_hint: "Try $0 (midpoint).",
      coach_feedback_label: "Coach feedback:",

      learn_title: "Turn a game into a teaching tool",
      learn_p1: "This edition turns the game into an interactive tool for teaching reasoning and binary-search efficiency.",
      learn_b1_title: "Candidate Count",
      learn_b1_desc: "See how information compresses as candidates shrink.",
      learn_b2_title: "Theoretical Min Steps (log2)",
      learn_b2_desc: "A concrete benchmark for strategy efficiency.",
      learn_b3_title: "Coach Feedback",
      learn_b3_desc: "Helps learners align actions with strategy.",

      cta_title: "Building a teaching tool or lesson plan?",
      cta_desc: "Share your needs. This game can evolve into classroom activities, assessments, or learning records.",
      cta_button: "Describe your needs in 60 seconds (mini survey)",
      privacy_note: "Privacy: anonymous analytics by default; survey is voluntary (email optional).",

      summary_attempts: "Attempts",
      summary_attempts_hint: "Limit: $0",
      summary_optimal: "Theoretical Min",
      summary_optimal_hint: "Best strategy â‰ˆ $0",
      summary_efficiency: "Efficiency",
      summary_efficiency_hint: "Closer to 1.00 means closer to optimal.",
      summary_time: "Time",
      summary_time_hint: "From start to finish.",
      summary_takeaway_title: "Takeaway"
    },

    jp: {
      badge_teaching: "Teaching Edition",
      badge_rule: "ç«¯ç‚¹ã‚’å«ã¾ãªã„ï¼ˆé–‹åŒºé–“ï¼‰",
      title: "ğŸ’ æ•™å­¦ç‰ˆï½œæ¨ç†ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°",
      subtitle: "ç¯„å›²ï¼š$0 ã‹ã‚‰ $1ï¼ˆç«¯ç‚¹ã‚’å«ã¾ãªã„ï¼‰",
      language: "è¨€èª",
      header_config: "âš™ï¸ ãƒ¢ãƒ¼ãƒ‰ï¼†é›£æ˜“åº¦",
      mode_novice: "åˆå¿ƒè€…",
      mode_elite: "æ¨™æº–",
      mode_ai_guardian: "ä¸Šç´š",
      mode_custom: "ã‚«ã‚¹ã‚¿ãƒ ",
      config_range: "æ•°å€¤ç¯„å›²",
      config_attempts: "æœ€å¤§å›æ•°",
      config_info: "$0ï¼šç¯„å›² $1 ã‹ã‚‰ $2ï¼ˆç«¯ç‚¹ãªã—ï¼‰ã€$3 å›ã€‚",
      start_game: "æ–°è¦é–‹å§‹",
      restart_game: "ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ",
      guess_button: "é€ä¿¡",
      input_placeholder: "$0 ã¨ $1 ã®é–“ï¼ˆç«¯ç‚¹ãªã—ï¼‰ã®æ•°å­—",
      attempt: "è©¦è¡Œ",
      current_mode: "ãƒ¢ãƒ¼ãƒ‰",
      high_score: "ãƒ™ã‚¹ãƒˆï¼ˆæœ€å°‘æ‰‹æ•°ï¼‰",
      status_playing: "æ¨ç†ä¸­â€¦å€™è£œã‚’çµã‚Šè¾¼ã¿ã¾ã™ã€‚",
      status_win: "æˆåŠŸï¼ğŸ‰ åŒºé–“åæŸãŒãã‚Œã„ã§ã—ãŸã€‚",
      status_loss: "å›æ•°åˆ‡ã‚Œã€‚ç­”ãˆã¯ $0",
      hint_too_low: "ä½ã™ã â†’ æ–°ã—ã„ç¯„å›²ï¼š",
      hint_too_high: "é«˜ã™ã â†’ æ–°ã—ã„ç¯„å›²ï¼š",
      error_invalid: "æœ‰åŠ¹ãªæ•´æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      error_range: "$0 ã¨ $1 ã®é–“ï¼ˆç«¯ç‚¹ãªã—ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      header_guess: "æ¨æ¸¬",
      header_result: "ãƒ’ãƒ³ãƒˆ",
      daily_toggle: "ãƒ‡ã‚¤ãƒªãƒ¼ãƒãƒ£ãƒ¬ãƒ³ã‚¸",
      daily_seed_label: "ä»Šæ—¥ã®ã‚·ãƒ¼ãƒ‰",
      settings: "è¨­å®š",
      settings_desc: "åˆ†æãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆãƒ»å‰Šé™¤ã‚’ç®¡ç†ã€‚",
      close: "é–‰ã˜ã‚‹",
      on: "ã‚ªãƒ³",
      off: "ã‚ªãƒ•",
      analytics_toggle_title: "åŒ¿ååˆ†æã‚’è¨±å¯",
      analytics_toggle_desc: "åŒ¿åã‚¤ãƒ™ãƒ³ãƒˆã®ã¿ï¼ˆãƒ¢ãƒ¼ãƒ‰ã€æ‰‹æ•°ã€ã‚¨ãƒ©ãƒ¼ç‡ï¼‰ã§æ”¹å–„ã—ã¾ã™ã€‚",
      export: "ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãå‡ºã™ï¼ˆJSONï¼‰",
      clear: "ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿å‰Šé™¤",
      survey_open: "ãƒŸãƒ‹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ",
      survey_hint: "æ•™è‚²ãƒ„ãƒ¼ãƒ«ã®è¦æœ›åé›†ï¼ˆãƒ¡ãƒ¼ãƒ«ä»»æ„ï¼‰ã€‚",
      settings_note: "ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ/å‰Šé™¤ã¯ä¿¡é ¼æ€§ã‚’ä¸Šã’ã¾ã™ã€‚å¾Œã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è¿½åŠ ã‚‚å¯èƒ½ã€‚",
      events_label: "ã‚¤ãƒ™ãƒ³ãƒˆè¨˜éŒ²æ•°",

      coach_on: "ã‚³ãƒ¼ãƒï¼šã‚ªãƒ³",
      coach_off: "ã‚³ãƒ¼ãƒï¼šã‚ªãƒ•",
      coach_title: "æ¨ç†ã‚³ãƒ¼ãƒ",
      coach_desc: "ä¸­ä½æ•°æ¨å¥¨ã¨æœ€é©æˆ¦ç•¥ã‹ã‚‰ã®ãšã‚Œã‚’èª¬æ˜ã—ã¾ã™ã€‚",
      coach_fill: "æ¨å¥¨å€¤ã‚’å…¥åŠ›",
      tip_midpoint: "ãƒ’ãƒ³ãƒˆï¼šä¸­ä½æ•°ãŒæœ‰åŠ¹ã€‚æ¨å¥¨ï¼š",
      candidates_label: "æ®‹ã‚Šå€™è£œ",
      candidates_hint: "å€™è£œ = ä¸Šé™ - ä¸‹é™ - 1ã€‚",
      optimal_label: "ç†è«–æœ€å°æ‰‹æ•°",
      optimal_hint: "æœ€é©æˆ¦ç•¥ â‰ˆ $0 æ‰‹ã€‚",
      recommend_label: "æ¨å¥¨",
      recommend_hint: "$0ï¼ˆä¸­ä½æ•°ï¼‰ã‚’è©¦ã™ã€‚",
      coach_feedback_label: "ã‚³ãƒ¼ãƒè©•ä¾¡ï¼š",

      learn_title: "ã‚²ãƒ¼ãƒ ã‚’æ•™è‚²ãƒ„ãƒ¼ãƒ«ã¸",
      learn_p1: "å€™è£œæ•°ã¨ç†è«–æœ€å°æ‰‹æ•°ã§ã€Œæƒ…å ±é‡ã€ã¨ã€ŒäºŒåˆ†æ¢ç´¢ã®åŠ¹ç‡ã€ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚",
      learn_b1_title: "å€™è£œæ•°",
      learn_b1_desc: "å€™è£œãŒæ¸›ã‚‹ã»ã©æƒ…å ±ãŒåœ§ç¸®ã•ã‚Œã¾ã™ã€‚",
      learn_b2_title: "ç†è«–æœ€å°æ‰‹æ•°ï¼ˆlog2ï¼‰",
      learn_b2_desc: "åŠ¹ç‡ã‚’æ•°å€¤ã§æ¯”è¼ƒã§ãã¾ã™ã€‚",
      learn_b3_title: "ã‚³ãƒ¼ãƒãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯",
      learn_b3_desc: "è¡Œå‹•ã‚’æˆ¦ç•¥ã«åˆã‚ã›ã¾ã™ã€‚",

      cta_title: "æ•™è‚²ãƒ„ãƒ¼ãƒ«ã‚„æ•™æã‚’é–‹ç™ºã—ã¦ã„ã¾ã™ã‹ï¼Ÿ",
      cta_desc: "è¦æœ›ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚æˆæ¥­æ´»å‹•ã‚„è©•ä¾¡ã«é€²åŒ–ã§ãã¾ã™ã€‚",
      cta_button: "60ç§’ã§è¦æœ›ã‚’è¨˜å…¥ï¼ˆãƒŸãƒ‹ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆï¼‰",
      privacy_note: "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ï¼šåŒ¿ååˆ†æãŒåŸºæœ¬ã€‚ã‚¢ãƒ³ã‚±ãƒ¼ãƒˆã¯ä»»æ„ï¼ˆãƒ¡ãƒ¼ãƒ«ä»»æ„ï¼‰ã€‚",

      summary_attempts: "æ‰‹æ•°",
      summary_attempts_hint: "ä¸Šé™ï¼š$0",
      summary_optimal: "ç†è«–æœ€å°",
      summary_optimal_hint: "æœ€é© â‰ˆ $0",
      summary_efficiency: "åŠ¹ç‡",
      summary_efficiency_hint: "1.00 ã«è¿‘ã„ã»ã©æœ€é©ã€‚",
      summary_time: "æ™‚é–“",
      summary_time_hint: "é–‹å§‹ã€œçµ‚äº†ã€‚",
      summary_takeaway_title: "å­¦ã³ï¼ˆTakeawayï¼‰"
    }
  };

  const STORAGE = {
    stateKey: "vault_teaching_state_v1",
    eventsKey: "vault_teaching_events_v1",
    profileKey: "vault_teaching_profile_v1"
  };

  function safeJsonParse(raw, fallback) {
    try { return raw ? JSON.parse(raw) : fallback; } catch { return fallback; }
  }
  function loadLS(key, fallback) {
    return safeJsonParse(localStorage.getItem(key), fallback);
  }
  function saveLS(key, val) {
    try { localStorage.setItem(key, JSON.stringify(val)); } catch {}
  }

  createApp({
    setup() {
      const GOOGLE_FORM_EMBED_URL =
        "https://docs.google.com/forms/d/e/1FAIpQLSfTzIxdxYJns_XAbN_mfYC7QEMJHM-DXT3_P2b4NICUZ663tQ/viewform?embedded=true";
      const GOOGLE_FORM_VIEW_URL =
        "https://docs.google.com/forms/d/e/1FAIpQLSfTzIxdxYJns_XAbN_mfYC7QEMJHM-DXT3_P2b4NICUZ663tQ/viewform";

      const guessInputRef = ref(null);

      const language = ref("zh");
      const t = computed(() => translations[language.value] || translations.zh);

      const analyticsEnabled = ref(true);
      const dailyChallengeEnabled = ref(true);
      const coachEnabled = ref(true);

      const settingsOpen = ref(false);
      const summaryOpen = ref(false);

      const gameModeKey = ref("elite_codebreaker");
      const gameModes = computed(() => gameModesConfig);

      const customMin = ref(1);
      const customMax = ref(100);
      const customAttempts = ref(10);

      const initialMin = ref(gameModesConfig.elite_codebreaker.min);
      const initialMax = ref(gameModesConfig.elite_codebreaker.max);
      const maxAttempts = ref(gameModesConfig.elite_codebreaker.attempts);

      const minRange = ref(initialMin.value);
      const maxRange = ref(initialMax.value);

      const secretNumber = ref(0);
      const guess = ref(null);
      const guesses = ref([]);
      const isInputInvalid = ref(false);

      const gameStatus = ref(null); // playing, won, lost, null
      const message = ref("");

      const highScore = ref(null);

      const gameStartAt = ref(null);

      const summary = ref({
        status: "won",
        attempts: 0,
        optimal: 0,
        efficiency: "1.00",
        time: "00:00",
        takeaway: ""
      });

      const surveyEmbedEnabled = computed(() =>
        String(GOOGLE_FORM_EMBED_URL || "").startsWith("https://docs.google.com/forms/")
      );
      const googleFormEmbedUrl = computed(() => GOOGLE_FORM_EMBED_URL);

      const surveyViewEnabled = computed(() =>
        String(GOOGLE_FORM_VIEW_URL || "").startsWith("https://docs.google.com/forms/")
      );
      const googleFormViewUrl = computed(() => GOOGLE_FORM_VIEW_URL);

      const profile = ref(loadLS(STORAGE.profileKey, {
        hasSeenSurvey: false,
        surveyShownCount: 0,
        totalSessions: 0,
        totalWins: 0,
        totalLosses: 0
      }));

      const events = ref(loadLS(STORAGE.eventsKey, []));
      const eventCount = computed(() => events.value.length);

      const currentAttempts = computed(() => guesses.value.length);

      const candidateCount = computed(() => Math.max(0, (maxRange.value - minRange.value - 1)));
      const theoreticalMinSteps = computed(() => {
        const n = candidateCount.value;
        if (n <= 1) return 0;
        return Math.ceil(Math.log2(n));
      });

      const recommendedGuess = computed(() => {
        const mid = Math.floor((minRange.value + maxRange.value) / 2);
        if (mid <= minRange.value) return minRange.value + 1;
        if (mid >= maxRange.value) return maxRange.value - 1;
        return mid;
      });

      const coachFeedback = computed(() => {
        if (!coachEnabled.value) return "";
        if (gameStatus.value !== "playing") return "";
        if (currentAttempts.value === 0) {
          return ({
            zh: "ç¬¬ä¸€æ­¥é€šå¸¸çŒœä¸­ä½æ•¸æœ€ç©©ï¼šå®ƒæœ€å¤§åŒ–æ¯æ­¥è³‡è¨Šé‡ï¼ˆåƒäºŒåˆ†æœå°‹ï¼‰ã€‚",
            en: "Midpoint is usually best: it maximizes information per step (binary-search-like).",
            jp: "ä¸­ä½æ•°ãŒå®‰å®šï¼š1æ‰‹ã‚ãŸã‚Šã®æƒ…å ±é‡ãŒæœ€å¤§ï¼ˆäºŒåˆ†æ¢ç´¢é¢¨ï¼‰ã€‚"
          }[language.value] || "Midpoint is best.");
        }

        const last = guesses.value[0];
        if (!last) return "";
        const lastMid = Math.floor((last.min + last.max) / 2);
        const delta = Math.abs(last.value - lastMid);

        if (delta === 0) return ({
          zh: "æ¼‚äº®ï¼ä½ çŒœåœ¨ä¸­ä½æ•¸ï¼Œé€™æ˜¯æ¥è¿‘æœ€å„ªç­–ç•¥çš„ä¸€æ­¥ã€‚",
          en: "Nice! You hit the midpoint â€” very close to optimal.",
          jp: "è‰¯ã„ï¼ä¸­ä½æ•°ã§ã€æœ€é©ã«è¿‘ã„ä¸€æ‰‹ã§ã™ã€‚"
        }[language.value] || "Nice midpoint.");

        if (delta <= 2) return ({
          zh: "å¾ˆæ¥è¿‘ä¸­ä½æ•¸ï¼ˆåå·®å¾ˆå°ï¼‰ï¼Œç­–ç•¥æ„Ÿä¸éŒ¯ã€‚",
          en: "Very close to the midpoint. Solid strategy.",
          jp: "ä¸­ä½æ•°ã«è¿‘ã„ã€‚è‰¯ã„æˆ¦ç•¥ã§ã™ã€‚"
        }[language.value] || "Close to midpoint.");

        return translate(({
          zh: "é€™æ­¥åé›¢ä¸­ä½æ•¸ $0ï¼Œä»å¯è¡Œï¼Œä½†è³‡è¨Šæ•ˆç‡ç•¥ä½ï¼›ä¸‹ä¸€æ­¥å»ºè­°æ›´é è¿‘ä¸­ä½æ•¸ã€‚",
          en: "This guess deviated $0 from midpoint. Still works, but less efficient; try closer next time.",
          jp: "ä¸­ä½æ•°ã‹ã‚‰ $0 ãšã‚Œã¾ã—ãŸã€‚å¯èƒ½ã§ã™ãŒåŠ¹ç‡ä½ã‚ã€‚æ¬¡ã¯ä¸­ä½æ•°å¯„ã‚ŠãŒãŠã™ã™ã‚ã€‚"
        }[language.value] || "Try closer to midpoint."), delta);
      });

      const dailySeedInfo = computed(() => {
        const date = todayISO();
        if (!dailyChallengeEnabled.value) return `${date} / random`;
        if (gameModeKey.value === "custom") return `${date} / custom`;
        return `${date} / ${gameModeKey.value}`;
      });

      const gameMessage = computed(() => {
        if (gameStatus.value === "won") return t.value.status_win;
        if (gameStatus.value === "lost") return translate(t.value.status_loss, secretNumber.value);
        if (message.value && gameStatus.value === "playing") return message.value;
        return t.value.status_playing;
      });

      function setHtmlLang() {
        const langMap = { zh: "zh-Hant", en: "en", jp: "ja" };
        document.documentElement.lang = langMap[language.value] || "zh-Hant";
      }

      function readQueryLang() {
        try {
          const u = new URL(window.location.href);
          const q = (u.searchParams.get("lang") || "").toLowerCase();
          if (q === "en") return "en";
          if (q === "ja" || q === "jp") return "jp";
          if (q === "zh" || q === "zh-hant" || q === "zh-tw") return "zh";
          return null;
        } catch {
          return null;
        }
      }

      function track(name, payload = {}) {
        if (!analyticsEnabled.value) return;

        const evt = {
          name,
          ts: new Date().toISOString(),
          lang: language.value,
          mode: gameModeKey.value,
          daily: !!dailyChallengeEnabled.value && gameModeKey.value !== "custom",
          min: minRange.value,
          max: maxRange.value,
          attemptNo: currentAttempts.value,
          ...payload
        };
        events.value.unshift(evt);
        if (events.value.length > 800) events.value.length = 800;
        saveLS(STORAGE.eventsKey, events.value);
      }

      function saveState() {
        const s = {
          language: language.value,
          analyticsEnabled: analyticsEnabled.value,
          dailyChallengeEnabled: dailyChallengeEnabled.value,
          coachEnabled: coachEnabled.value,
          highScore: highScore.value,
          gameModeKey: gameModeKey.value,
          customMin: customMin.value,
          customMax: customMax.value,
          customAttempts: customAttempts.value
        };
        saveLS(STORAGE.stateKey, s);
        saveLS(STORAGE.profileKey, profile.value);
      }

      function loadState() {
        const s = loadLS(STORAGE.stateKey, null);
        if (s) {
          if (["zh","en","jp"].includes(s.language)) language.value = s.language;
          if (typeof s.analyticsEnabled === "boolean") analyticsEnabled.value = s.analyticsEnabled;
          if (typeof s.dailyChallengeEnabled === "boolean") dailyChallengeEnabled.value = s.dailyChallengeEnabled;
          if (typeof s.coachEnabled === "boolean") coachEnabled.value = s.coachEnabled;
          if (typeof s.highScore === "number" && s.highScore > 0) highScore.value = s.highScore;

          if (s.gameModeKey && gameModesConfig[s.gameModeKey]) {
            gameModeKey.value = s.gameModeKey;
            if (s.gameModeKey === "custom") {
              customMin.value = s.customMin || 1;
              customMax.value = s.customMax || 100;
              customAttempts.value = s.customAttempts || 10;
            }
          }
        }

        const qLang = readQueryLang();
        if (qLang) language.value = qLang;
        setHtmlLang();
      }

      function getRngForCurrentGame(min, max) {
        const useDaily = !!dailyChallengeEnabled.value && gameModeKey.value !== "custom";
        if (!useDaily) return Math.random;

        const seedStr = `${todayISO()}|${gameModeKey.value}|${min}|${max}`;
        const seed = hash32(seedStr);
        return mulberry32(seed);
      }

      function startGame() {
        let currentMin, currentMax, attemptsLimit;

        if (gameModeKey.value === "custom") {
          currentMin = clampInt(customMin.value, 1, 9999);
          currentMax = clampInt(customMax.value, currentMin + 1, 10000);
          attemptsLimit = clampInt(customAttempts.value, 1, 50);
        } else {
          const mode = gameModesConfig[gameModeKey.value];
          currentMin = mode.min;
          currentMax = mode.max;
          attemptsLimit = mode.attempts;
        }

        if ((currentMax - currentMin) <= 2) currentMax = Math.max(currentMax, currentMin + 3);

        initialMin.value = currentMin;
        initialMax.value = currentMax;
        maxAttempts.value = attemptsLimit;

        minRange.value = currentMin;
        maxRange.value = currentMax;

        const rng = getRngForCurrentGame(currentMin, currentMax);
        secretNumber.value = Math.floor(rng() * (currentMax - currentMin - 1)) + currentMin + 1;

        guesses.value = [];
        guess.value = null;
        gameStatus.value = "playing";
        isInputInvalid.value = false;
        message.value = t.value.status_playing;

        gameStartAt.value = Date.now();

        profile.value.totalSessions = (profile.value.totalSessions || 0) + 1;
        saveState();

        track("game_start", { initialMin: currentMin, initialMax: currentMax, attemptsLimit });
        nextTick(() => guessInputRef.value?.focus());
      }

      function buildTakeaway(status, attempts, optimal, eff) {
        const effNum = Number(eff);
        const base = {
          zh: `ä½ æŠŠå€™é¸æ•¸é€æ­¥å£“ç¸®ï¼Œé€™æ­£æ˜¯ã€Œè³‡è¨Šé‡ã€åœ¨å·¥ä½œã€‚ç†è«–æœ€å°‘æ­¥æ•¸æ˜¯ ${optimal}ï¼Œä½ ç”¨äº† ${attempts} æ­¥ï¼ˆæ•ˆç‡ ${eff}ï¼‰ã€‚`,
          en: `You compressed candidates â€” that's information at work. Theoretical min is ${optimal}, you used ${attempts} steps (efficiency ${eff}).`,
          jp: `å€™è£œã‚’åœ§ç¸®ã—ã¾ã—ãŸã€‚ç†è«–æœ€å°ã¯ ${optimal}ã€ã‚ãªãŸã¯ ${attempts} æ‰‹ï¼ˆåŠ¹ç‡ ${eff}ï¼‰ã€‚`
        }[language.value] || "";

        const advice = (effNum <= 1.15)
          ? ({ zh:"ç­–ç•¥å¾ˆæ¥è¿‘æœ€å„ªï¼šä¿æŒã€Œä¸­ä½æ•¸ã€æ€ç¶­å³å¯ã€‚", en:"Very close to optimal: keep using midpoint thinking.", jp:"æœ€é©ã«è¿‘ã„ï¼šä¸­ä½æ•°æ€è€ƒã‚’ç¶™ç¶šã€‚" }[language.value])
          : (effNum <= 1.5)
            ? ({ zh:"å·²å…·å‚™ç­–ç•¥æ„Ÿï¼šä¸‹ä¸€æ¬¡æ›´é è¿‘ä¸­ä½æ•¸ï¼Œæ•ˆç‡æœƒæ›´æ¼‚äº®ã€‚", en:"Good strategy: aim closer to midpoint for better efficiency.", jp:"è‰¯ã„ï¼šä¸­ä½æ•°å¯„ã‚Šã§ã•ã‚‰ã«åŠ¹ç‡UPã€‚" }[language.value])
            : ({ zh:"åé›¢æœ€å„ªè¼ƒå¤šï¼šå»ºè­°æ¯æ­¥å…ˆçœ‹ä¸­ä½æ•¸ï¼Œè®“æ¯æ¬¡çŒœæ¸¬æœ€å¤§åŒ–è³‡è¨Šé‡ã€‚", en:"Quite off optimal: try midpoint each step to maximize information.", jp:"æœ€é©ã‹ã‚‰é ã„ï¼šæ¯å›ä¸­ä½æ•°ã§æƒ…å ±é‡æœ€å¤§åŒ–ã‚’ã€‚" }[language.value]);

        const statusLine = status === "won"
          ? ({ zh:"ä½ æˆåŠŸå®Œæˆä¸€æ¬¡æ”¶æ–‚ã€‚é€™å¯æ‹¿ä¾†æ•™ã€ŒäºŒåˆ†æœå°‹ã€æˆ–ã€Œæ±ºç­–æ¨¹ã€çš„æ¦‚å¿µã€‚", en:"You completed a convergence â€” great for teaching binary search / decision trees.", jp:"åæŸå®Œäº†ã€‚äºŒåˆ†æ¢ç´¢ã‚„æ±ºå®šæœ¨ã®æ•™æã«æœ€é©ã€‚" }[language.value])
          : ({ zh:"é›–ç„¶æ²’ç ´è§£ï¼Œä½†ä½ å·²ç¸®å°å¤§é‡å€™é¸ã€‚æŠŠæ¯æ­¥åé›¢ä¸­ä½æ•¸çš„ç¨‹åº¦é™ä½ï¼Œå‹ç‡æœƒä¸Šå‡ã€‚", en:"Even if you lost, you reduced candidates. Reduce deviation from midpoint to improve.", jp:"è² ã‘ã¦ã‚‚å€™è£œã¯æ¸›ã£ãŸã€‚ä¸­ä½æ•°ã‹ã‚‰ã®ã‚ºãƒ¬ã‚’æ¸›ã‚‰ã™ã¨å‹ç‡UPã€‚" }[language.value]);

        return `${statusLine} ${base} ${advice}`;
      }

      function openSummary(status) {
        const endAt = Date.now();
        const elapsed = gameStartAt.value ? (endAt - gameStartAt.value) : 0;

        const attempts = guesses.value.length;
        const optimal = theoreticalMinSteps.value;
        const efficiencyNum = optimal > 0 ? (attempts / optimal) : 1;
        const efficiency = efficiencyNum.toFixed(2);

        summary.value = {
          status,
          attempts,
          optimal,
          efficiency,
          time: msToClock(elapsed),
          takeaway: buildTakeaway(status, attempts, optimal, efficiency)
        };

        summaryOpen.value = true;

        profile.value.surveyShownCount = (profile.value.surveyShownCount || 0) + 1;
        saveState();
      }

      function closeSummary() {
        summaryOpen.value = false;
      }

      const summaryStatusTitle = computed(() => {
        if (!summaryOpen.value) return "";
        if (summary.value.status === "won") return ({ zh:"ğŸ‰ Summaryï¼šç ´è§£æˆåŠŸ", en:"ğŸ‰ Summary: Success", jp:"ğŸ‰ Summaryï¼šæˆåŠŸ" }[language.value] || "Summary");
        return ({ zh:"ğŸ§  Summaryï¼šå·®ä¸€é»ï¼Œä½†å­¸åˆ°å¾ˆå¤š", en:"ğŸ§  Summary: Close call", jp:"ğŸ§  Summaryï¼šæƒœã—ã„" }[language.value] || "Summary");
      });

      const summarySubtitle = computed(() => {
        const modeName = t.value[gameModesConfig[gameModeKey.value]?.nameKey] || gameModeKey.value;
        const daily = (!!dailyChallengeEnabled.value && gameModeKey.value !== "custom")
          ? ({ zh:"æ¯æ—¥æŒ‘æˆ°", en:"Daily Challenge", jp:"ãƒ‡ã‚¤ãƒªãƒ¼" }[language.value])
          : ({ zh:"éš¨æ©Ÿé¡Œ", en:"Random", jp:"ãƒ©ãƒ³ãƒ€ãƒ " }[language.value]);
        return `${modeName} Â· ${daily} Â· ${todayISO()}`;
      });

      function makeGuess() {
        const currentGuess = Number.parseInt(guess.value, 10);

        if (Number.isNaN(currentGuess)) {
          message.value = t.value.error_invalid;
          isInputInvalid.value = true;
          track("guess_submit", { result: "invalid" });
          nextTick(() => guessInputRef.value?.focus());
          return;
        }

        if (currentGuess <= minRange.value || currentGuess >= maxRange.value) {
          message.value = translate(t.value.error_range, minRange.value, maxRange.value);
          isInputInvalid.value = true;
          track("guess_submit", { result: "out_of_range", guess: currentGuess });
          nextTick(() => guessInputRef.value?.focus());
          return;
        }

        isInputInvalid.value = false;

        if (currentGuess === secretNumber.value) {
          gameStatus.value = "won";
          message.value = t.value.status_win;

          guesses.value.unshift({
            value: currentGuess,
            hint: t.value.status_win,
            min: minRange.value,
            max: maxRange.value
          });

          profile.value.totalWins = (profile.value.totalWins || 0) + 1;

          if (highScore.value === null || guesses.value.length < highScore.value) highScore.value = guesses.value.length;
          saveState();

          track("guess_submit", { result: "win", guess: currentGuess });
          track("game_end", { result: "won" });

          openSummary("won");
          return;
        }

        let newMin = minRange.value;
        let newMax = maxRange.value;
        let result = "high";
        let hintText = "";

        if (currentGuess < secretNumber.value) {
          newMin = currentGuess;
          hintText = `${t.value.hint_too_low} (${currentGuess} - ${maxRange.value})`;
          result = "low";
        } else {
          newMax = currentGuess;
          hintText = `${t.value.hint_too_high} (${minRange.value} - ${currentGuess})`;
          result = "high";
        }

        guesses.value.unshift({ value: currentGuess, hint: hintText, min: newMin, max: newMax });

        minRange.value = newMin;
        maxRange.value = newMax;
        message.value = t.value.status_playing;

        track("guess_submit", { result, guess: currentGuess, newMin, newMax });

        if (guesses.value.length >= maxAttempts.value) {
          gameStatus.value = "lost";
          message.value = translate(t.value.status_loss, secretNumber.value);

          profile.value.totalLosses = (profile.value.totalLosses || 0) + 1;
          saveState();

          track("game_end", { result: "lost", secret: secretNumber.value });
          openSummary("lost");
        }

        guess.value = null;
        if (gameStatus.value === "playing") nextTick(() => guessInputRef.value?.focus());
      }

      function setGameMode(key) {
        const prev = gameModeKey.value;
        if (!gameModesConfig[key]) return;

        gameModeKey.value = key;

        if (key !== "custom") {
          const cfg = gameModesConfig[key];
          customMin.value = cfg.min;
          customMax.value = cfg.max;
          customAttempts.value = cfg.attempts;
          minRange.value = cfg.min;
          maxRange.value = cfg.max;
        } else {
          minRange.value = customMin.value;
          maxRange.value = customMax.value;
        }

        gameStatus.value = null;
        message.value = "";
        saveState();
        track("mode_change", { from: prev, to: key });
      }

      watch([customMin, customMax, customAttempts], () => {
        if (gameModeKey.value === "custom") {
          customMin.value = clampInt(customMin.value, 1, 9999);
          customMax.value = clampInt(customMax.value, customMin.value + 1, 10000);
          customAttempts.value = clampInt(customAttempts.value, 1, 50);

          minRange.value = customMin.value;
          maxRange.value = customMax.value;

          gameStatus.value = null;
          saveState();
        }
      });

      function changeLanguage(lang) {
        const prev = language.value;
        if (!["zh","en","jp"].includes(lang)) return;
        language.value = lang;
        setHtmlLang();
        saveState();
        track("lang_change", { from: prev, to: lang });
      }

      function toggleCoach() {
        coachEnabled.value = !coachEnabled.value;
        saveState();
        track("coach_toggle", { enabled: coachEnabled.value });
      }

      function applyRecommendedGuess() {
        guess.value = recommendedGuess.value;
        nextTick(() => guessInputRef.value?.focus());
        track("coach_apply", { recommended: recommendedGuess.value });
      }

      function openSettings() {
        settingsOpen.value = true;
        track("settings_open");
      }

      function closeSettings() {
        settingsOpen.value = false;
      }

      function exportMyData() {
        const payload = {
          exportedAt: new Date().toISOString(),
          state: loadLS(STORAGE.stateKey, {}),
          profile: loadLS(STORAGE.profileKey, {}),
          events: loadLS(STORAGE.eventsKey, [])
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "vault-teaching-export.json";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);

        track("export");
      }

      function clearLocalData() {
        localStorage.removeItem(STORAGE.stateKey);
        localStorage.removeItem(STORAGE.eventsKey);
        localStorage.removeItem(STORAGE.profileKey);
        events.value = [];
        profile.value = { hasSeenSurvey:false, surveyShownCount:0, totalSessions:0, totalWins:0, totalLosses:0 };
        highScore.value = null;

        track("clear");
        settingsOpen.value = false;

        loadState();
        startGame();
      }

      function openSurvey(source) {
        track("survey_open", { source });

        if (!summaryOpen.value) summaryOpen.value = true;

        if (surveyViewEnabled.value) {
          window.open(googleFormViewUrl.value, "_blank", "noopener,noreferrer");
        }

        profile.value.hasSeenSurvey = true;
        saveState();
      }

      // âœ… ESC close support for Summary + Settings (donâ€™t trap users)
      function onKeydown(e) {
        if (e.key !== "Escape") return;
        if (summaryOpen.value) closeSummary();
        else if (settingsOpen.value) closeSettings();
      }

      onMounted(() => {
        window.addEventListener("keydown", onKeydown, { passive: true });
      });
      onBeforeUnmount(() => {
        window.removeEventListener("keydown", onKeydown);
      });

      watch(language, () => setHtmlLang());
      watch([analyticsEnabled, dailyChallengeEnabled, coachEnabled], () => saveState());

      loadState();
      startGame();

      return {
        language, t,
        translate,
        guessInputRef,
        analyticsEnabled,
        dailyChallengeEnabled,
        coachEnabled,
        settingsOpen,
        summaryOpen,

        gameModeKey, gameModes,
        customMin, customMax, customAttempts,

        initialMin, initialMax,
        minRange, maxRange,
        secretNumber,
        guess, guesses,
        isInputInvalid,
        gameStatus,
        message,

        highScore,
        maxAttempts,
        currentAttempts,

        candidateCount,
        theoreticalMinSteps,
        recommendedGuess,
        coachFeedback,
        dailySeedInfo,

        eventCount,

        summary,
        summaryStatusTitle,
        summarySubtitle,

        surveyEmbedEnabled,
        googleFormEmbedUrl,
        surveyViewEnabled,
        googleFormViewUrl,

        startGame,
        makeGuess,
        setGameMode,
        changeLanguage,
        toggleCoach,
        applyRecommendedGuess,
        openSettings,
        closeSettings,
        closeSummary,
        openSurvey,
        exportMyData,
        clearLocalData
      };
    }
  }).mount("#app");
</script>

</body>
</html>
